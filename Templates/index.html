<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRI Foresight Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Navigation */
        .navbar {
            background-color: #1a237e;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .nav-links a:hover {
            opacity: 0.8;
        }

        /* Main Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .progress-indicator {
            margin-bottom: 2rem;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            background: #4caf50;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .phase-list {
            list-style: none;
        }

        .phase-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .phase-item:hover {
            background: #f5f7fa;
        }

        .phase-item.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        .phase-item.completed {
            color: #4caf50;
        }

        .phase-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .phase-item.completed .phase-icon {
            background: #4caf50;
            color: white;
        }

        .phase-item.active .phase-icon {
            background: #1976d2;
            color: white;
        }

        /* Main Content Area */
        .main-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .content-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .content-header h1 {
            color: #1a237e;
            margin-bottom: 0.5rem;
        }

        .content-header p {
            color: #666;
        }

        /* Form Elements */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        input[type="text"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #1976d2;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #1976d2;
            background: #f5f7fa;
        }

        .upload-icon {
            font-size: 3rem;
            color: #999;
            margin-bottom: 1rem;
        }

        /* AI Generation Card */
        .ai-card {
            background: #f5f7fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .ai-badge {
            background: #673ab7;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #f5f7fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-ai {
            background: #673ab7;
            color: white;
        }

        .btn-ai:hover {
            background: #5e35b1;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        /* Generated Content */
        .generated-content {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            position: relative;
        }

        .edit-toggle {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: white;
            border: 1px solid #ddd;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f5f7fa;
        }

        .tab.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card h4 {
            color: #1a237e;
            margin-bottom: 0.75rem;
        }

        .card p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Signal Cards */
        .signal-card {
            background: #f8f9fa;
            border-left: 4px solid #1976d2;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .signal-card.weak {
            border-left-color: #ff9800;
        }

        .signal-card.strong {
            border-left-color: #4caf50;
        }

        /* Matrix Builder */
        .matrix-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 1.5rem;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .matrix-cell {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .matrix-cell:hover {
            background: #f5f7fa;
        }

        .matrix-header {
            background: #1a237e;
            color: white;
            font-weight: bold;
        }

        /* Hide/Show Content */
        .phase-content {
            display: none;
        }

        .phase-content.active {
            display: block;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }

            /* ADD this new rule */
            .container {
                padding: 1rem;
            }
        }

        /* Phase 3 Specific CSS - Add these rules to your existing CSS file */

        /* Scenario Builder - NEW */
        .scenario-builder {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Outcome content visibility - NEW */
        .outcome-content {
            display: none;
        }

        .outcome-content.active {
            display: block;
        }

        /* Add these CSS rules to fix the mind map layout issues */
        /* Mind map container fixes */
        #mindmap-content {
            width: 100%;
            max-width: 100%;
            overflow: visible;
            margin-bottom: 2rem; /* Add space after mind map */
            z-index: 1; /* Ensure it doesn't overlap other content */
        }

        #mindmap-visualization {
            width: 100%;
            height: 700px; /* Fixed height */
            border: 1px solid #ddd;
            margin-top: 1rem;
            margin-bottom: 2rem;
            overflow: visible;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Ensure the SVG fits properly */
        #mindmap-visualization svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
        }

        /* Fix for generated content sections */
        .generated-content {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            overflow: visible;
        }

        /* Ensure form sections are properly spaced and visible */
        .form-section {
            margin-bottom: 3rem;
            clear: both;
            overflow: visible;
            z-index: auto;
        }

        /* Fix for phases 2 and 3 visibility */
        .form-section h3 {
            margin-bottom: 1rem;
            margin-top: 2rem;
            font-weight: bold;
            color: #333;
        }

        /* Ensure AI cards don't get hidden */
        .ai-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            z-index: auto;
        }

        /* Button container spacing */
        .ai-card > div[style*="display: flex"] {
            margin-bottom: 1rem;
        }

        /* Ensure content flows properly */
        body, html {
            overflow-x: auto;
            overflow-y: auto;
        }

        /* Fix any potential absolute positioning issues */
        * {
            position: relative;
        }

        /* Override any potential hidden styles */
        .form-section:not(:first-child) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Make sure phases are visible */
        .form-section:nth-child(n+2) {
            display: block !important;
            margin-top: 2rem;
        }

        /* Policy Stress Overlay */
        .policy-stress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .policy-stress-container {
            background: white;
            border-radius: 12px;
            max-width: 95vw;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .policy-stress-header {
            background: #1a237e;
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .policy-stress-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.75rem;
        }

        .policy-stress-header p {
            margin: 0;
            opacity: 0.9;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Input Section */
        .policy-stress-input {
            padding: 2rem;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .input-section h3 {
            color: #1a237e;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .policy-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .policy-upload-area:hover {
            border-color: #1976d2;
            background: #f5f7fa;
        }

        .upload-success {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .upload-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        /* Loading Section */
        .loading-section {
            text-align: center;
            padding: 3rem 2rem;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .step {
            padding: 0.75rem;
            border-radius: 6px;
            background: #f5f7fa;
            color: #666;
            transition: all 0.3s;
        }

        .step.active {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 500;
        }

        /* Results Grid */
        .results-grid {
            padding: 2rem;
        }

        .result-section {
            margin-bottom: 3rem;
            background: #fafafa;
            border-radius: 8px;
            overflow: hidden;
        }

        .result-header {
            background: #1a237e;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-header h3 {
            margin: 0;
        }

        .phase-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .result-card {
            background: white;
            margin: 1rem;
            padding: 1.5rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .result-card h4 {
            color: #1a237e;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Domain Map Visual */
        .domain-map-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 1.5rem 0;
        }

        .central-domain {
            background: #1976d2;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-align: center;
        }

        .sub-domains {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            width: 100%;
        }

        .sub-domain-item {
            background: #f5f7fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        /* Progress Steps Grid */
        .progress-steps-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 8px;
            background: #f5f7fa;
            color: #666;
            transition: all 0.3s;
            text-align: center;
        }

        .progress-step.active {
            background: #e3f2fd;
            color: #1976d2;
            transform: scale(1.05);
        }

        .progress-step.completed {
            background: #e8f5e9;
            color: #4caf50;
        }

        .step-icon {
            font-size: 2rem;
        }

        .step-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Signal items styling */
        .signal-item {
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .strong-signal {
            border-left-color: #d32f2f;
        }

        .weak-signal {
            border-left-color: #f57c00;
        }

        /* Signals Grid */
        .signals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .signal-category h5 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signal-item {
            background: #f8f9fa;
            border-left: 4px solid #ddd;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .strong-signals .signal-item {
            border-left-color: #f44336;
        }

        .weak-signals .signal-item {
            border-left-color: #ff9800;
        }

        /* STEEPV Grid */
        .steepv-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .steepv-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
        }

        .steepv-item h5 {
            color: #1976d2;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        /* Futures Triangle Result */
        .futures-triangle-result {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .triangle-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
        }

        .triangle-section.pull {
            border-left: 4px solid #4caf50;
        }

        .triangle-section.push {
            border-left: 4px solid #2196f3;
        }

        .triangle-section.weight {
            border-left: 4px solid #ff5722;
        }

        .triangle-content div {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        /* FT2 Grid */
        .ft2-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .ft2-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1rem;
        }

        .ft2-section h5 {
            color: #1976d2;
            margin-bottom: 1rem;
        }

        /* Scenario Content */
        .scenario-content {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1.5rem;
        }

        .scenario-content h5 {
            color: #1976d2;
            margin-bottom: 1rem;
        }

        /* Outcomes Tabs */
        .outcomes-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .outcome-tab {
            padding: 0.5rem 1rem;
            border: 1px solid #e0e0e0;
            background: #f5f7fa;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .outcome-tab:hover {
            background: #e0e0e0;
        }

        .outcome-tab.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .outcome-content-area {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1.5rem;
            min-height: 200px;
        }

        /* Alternative Scenarios */
        .scenario-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .scenario-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .scenario-collapse {
            background: #ffebee;
            color: #c62828;
        }

        .scenario-equilibrium {
            background: #fff3e0;
            color: #e65100;
        }

        .scenario-transformation {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Export Section */
        .export-section {
            background: #f5f7fa;
            padding: 2rem;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .signals-grid,
            .steepv-grid,
            .futures-triangle-result,
            .ft2-grid {
                grid-template-columns: 1fr;
            }
            
            .outcomes-tabs {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
                align-items: center;
            }

            .progress-steps-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .progress-step {
                padding: 0.75rem 0.5rem;
            }
            
            .step-icon {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">DRI Foresight Framework</div>
            <ul class="nav-links">
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="#projects">Projects</a></li>
                <li><a href="#help">Help</a></li>
                <li><a href="#profile">Profile</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="dashboard-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="progress-indicator">
                    <h3>Project Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                        <span id="progress-text">0</span>% Complete
                    </p>
                </div>

                <nav class="phase-navigation">
                    <h3 style="margin-bottom: 1rem;">Framework Phases</h3>
                    <ul class="phase-list">
                        <li class="phase-item active" data-phase="1">
                            <span class="phase-icon">1</span>
                            <span>Framing</span>
                        </li>
                        <li class="phase-item" data-phase="2">
                            <span class="phase-icon">2</span>
                            <span>Horizon Scanning</span>
                        </li>
                        <li class="phase-item" data-phase="3">
                            <span class="phase-icon">3</span>
                            <span>Futuring</span>
                        </li>
                        <li class="phase-item" data-phase="4">
                            <span class="phase-icon">4</span>
                            <span>Visioning</span>
                        </li>
                        <li class="phase-item" data-phase="5">
                            <span class="phase-icon">5</span>
                            <span>Designing</span>
                        </li>
                        <li class="phase-item" data-phase="6">
                            <span class="phase-icon">6</span>
                            <span>Adapting</span>
                        </li>
                    </ul>
                </nav>

                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e0e0e0;">
                    <button class="btn btn-secondary" style="width: 100%;">
                        üì• Export Project
                    </button>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-ai" style="width: 100%;" onclick="switchToPhase('policy-stress')">
                        ‚ö° Policy Stress Test
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Phase 1: Framing -->
                <div id="phase-1" class="phase-content active">
                    <div class="content-header">
                        <h1>Phase 1: Framing</h1>
                        <p>Define the project scope, domain, and establish baseline understanding</p>
                    </div>

                    <!-- Project Setup Form -->
                    <div class="form-section">
                        <h3>Project Setup</h3>
                        <div class="form-group">
                            <label for="project-name">1. Project Name</label>
                            <input type="text" id="project-name" placeholder="Enter project name">
                        </div>
                        <div class="form-group">
                            <label for="domain-select">2. Domain Focus</label>
                            <select id="domain-select" onchange="handleDomainSelection()">
                                <option value="">Choose from past projects or create new...</option>
                                <optgroup label="Past Projects">
                                    <option value="food-security">Food Security & Self-Sufficiency in Lao PDR</option>
                                    <option value="human-capital">Human Capital & TVET Development</option>
                                    <option value="sme-fiscal">SMEs & Fiscal Policy Reform</option>
                                    <option value="renewable-energy">Renewable Energy Transition</option>
                                    <option value="digital-economy">Digital Economy Transformation</option>
                                </optgroup>
                                <option value="new">+ Create New Domain</option>
                            </select>
                        </div>
                        <div class="form-group" id="new-domain-input" style="display: none;">
                            <label for="new-domain-name">New Domain Name</label>
                            <input type="text" id="new-domain-name" placeholder="Enter new domain focus">
                        </div>
                    </div>

                    <!-- Upload Draft Domain Map -->
                    <div class="form-section">
                        <h3>3. Upload Draft Domain Map</h3>
                        <div class="upload-area" onclick="document.getElementById('domain-map-file').click()">
                            <div class="upload-icon">üó∫Ô∏è</div>
                            <p><strong>Upload existing domain map</strong></p>
                            <p style="font-size: 0.9rem; color: #666;">Supports PDF, Word, PowerPoint, or image files</p>
                            <input type="file" id="domain-map-file" style="display: none;" accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png" multiple>
                        </div>
                        <div id="domain-map-upload-status" style="margin-top: 1rem; display: none;">
                            <div class="signal-card strong">
                                <h4>‚úÖ Domain Map Uploaded</h4>
                                <p id="domain-map-filename"></p>
                                <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="removeDomainMapUpload()">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Domain Map Generation -->
                    <div class="form-section">
                        <h3>4. Domain Map Development</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>AI-Enhanced Domain Map</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Generate or refine domain map based on uploaded draft and selected focus</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-ai" onclick="generateDomainMap()">
                                    <span>ü§ñ</span>
                                    Generate Domain Map
                                </button>
                                <!-- <button class="btn btn-secondary" onclick="refineDomainMap()" id="refine-btn" style="display: none;">
                                    <span>üîß</span>
                                    Refine Existing Map
                                </button> -->
                                <button class="btn btn-ai" onclick="generateMindMap()" id="mindmap-btn" style="display: none;">
                                    <span>üß†</span>
                                    Generate Mind Map
                                </button>
                            </div>
                            
                            <div class="generated-content" id="domain-map-content" style="display: none;"></div>
                            <div class="generated-content" id="mindmap-content" style="display: none;">
                                <h4>Domain Mind Map</h4>
                                <div id="mindmap-visualization" style="width: 100%; height: 600px; border: 1px solid #ddd; margin-top: 1rem;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Interview Data Upload -->
                    <div class="form-section">
                        <h3>5. Interview Data</h3>
                        <div class="upload-area" onclick="document.getElementById('interview-files').click()">
                            <div class="upload-icon">üé§</div>
                            <p><strong>Upload interview transcripts or summaries</strong></p>
                            <p style="font-size: 0.9rem; color: #666;">Supports PDF, Word, Excel, audio files, or transcripts</p>
                            <input type="file" id="interview-files" style="display: none;" multiple accept=".pdf,.doc,.docx,.xlsx,.xls,.txt,.mp3,.wav,.m4a">
                        </div>
                        <div id="interview-upload-list" style="margin-top: 1rem;"></div>
                        
                        <div style="margin-top: 1.5rem;">
                            <h4>Interview Analysis</h4>
                            <button class="btn btn-ai" onclick="analyzeInterviews()" id="analyze-interviews-btn" disabled>
                                <span>üìä</span>
                                Analyze Interview Data
                            </button>
                            <div id="interview-analysis" style="display: none; margin-top: 1rem;">
                                <div class="generated-content" id="interview-analysis-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <!-- UPDATE: Navigation Buttons in Phase 1 -->
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="savePhase1Progress()">
                            <span>üíæ</span>
                            Save Progress
                        </button>
                        <button class="btn btn-primary" onclick="nextPhase(2)">Continue to Scanning ‚Üí</button>
                    </div>
                </div>


                <!-- Phase 2: Horizon Scanning -->
                <div id="phase-2" class="phase-content">
                    <div class="content-header">
                        <h1>Phase 2: Horizon Scanning</h1>
                        <p>Identify signals of change using STEEPV framework and Futures Triangle</p>
                    </div>

                    <!-- Upload Signals -->
                    <div class="form-section">
                        <h3>1. Upload Signals</h3>
                        <div class="upload-area" onclick="document.getElementById('signals-upload').click()">
                            <div class="upload-icon">üì°</div>
                            <p><strong>Upload signals, trends, and emerging issues</strong></p>
                            <p style="font-size: 0.9rem; color: #666;">Supports PDF, Word, Excel, CSV, and text files</p>
                            <input type="file" id="signals-upload" style="display: none;" multiple accept=".pdf,.doc,.docx,.xlsx,.xls,.csv,.txt">
                        </div>
                        <div id="signals-upload-list" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Signals Generation -->
                    <div class="form-section">
                        <h3>2. Generate Strong & Weak Signals</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>AI-Powered Signal Detection</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Generate signals using uploaded documents and interviews</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <div class="button-group" style="gap: 0.75rem; margin-top: 0;">
                                <button class="btn btn-ai" onclick="generateSignals()">
                                    <span>üîç</span>
                                    Generate Strong & Weak Signals
                                </button>
                                <button class="btn btn-secondary" onclick="generateAISuggestions()" id="ai-suggestions-btn" disabled>
                                    <span>üí°</span>
                                    Generate AI Suggestions
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Signals Tabs -->
                    <div class="form-section" id="signals-section" style="display: none;">
                        <div class="tabs" id="signals-tabs">
                            <div class="tab active" data-tab="strong">Strong Signals</div>
                            <div class="tab" data-tab="weak">Weak Signals</div>
                            <div class="tab" data-tab="ai-suggestions">AI Suggestions</div>
                        </div>
                        <div id="signals-strong" class="generated-content" style="display: none;"></div>
                        <div id="signals-weak" class="generated-content" style="display: none;"></div>
                        <div id="signals-ai" class="generated-content" style="display: none;"></div>
                    </div>

                    <!-- STEEPV Analysis -->
                    <div class="form-section">
                        <h3>3. STEEPV Analysis</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>Generate STEEPV Analysis</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Automatically categorize signals using STEEPV framework</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <button class="btn btn-ai" onclick="generateSTEEPV()" id="generate-steepv-btn" disabled>
                                <span>üìä</span>
                                Generate STEEPV Analysis
                            </button>
                        </div>
                    </div>    
                    <!-- STEEPV Analysis Section - UPDATE -->
                    <div id="steepv-content" style="display: none;">
                        <div class="matrix-container">
                            <div class="matrix-grid">
                                <div class="matrix-cell matrix-header"><strong>S</strong>ocial</div>
                                <div class="matrix-cell" id="steepv-social" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated social signals will appear here...</div>
                                
                                <div class="matrix-cell matrix-header"><strong>T</strong>echnological</div>
                                <div class="matrix-cell" id="steepv-technological" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated technological signals will appear here...</div>
                                
                                <div class="matrix-cell matrix-header"><strong>E</strong>conomic</div>
                                <div class="matrix-cell" id="steepv-economic" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated economic signals will appear here...</div>
                                
                                <div class="matrix-cell matrix-header"><strong>E</strong>nvironmental</div>
                                <div class="matrix-cell" id="steepv-environmental" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated environmental signals will appear here...</div>
                                
                                <div class="matrix-cell matrix-header"><strong>P</strong>olitical</div>
                                <div class="matrix-cell" id="steepv-political" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated political signals will appear here...</div>
                                
                                <div class="matrix-cell matrix-header"><strong>V</strong>alues</div>
                                <div class="matrix-cell" id="steepv-values" contenteditable="true" style="min-height: 100px; border: 1px solid #ddd; padding: 10px;">Generated values-based signals will appear here...</div>
                            </div>
                        </div>
                        
                        <!-- Save Button for STEEPV -->
                        <div style="margin-top: 1rem; text-align: center;">
                            <button class="btn btn-primary" onclick="saveSTEEPV()" id="save-steepv-btn">
                                <span>üíæ</span>
                                Save STEEPV Analysis
                            </button>
                        </div>
                    </div>

                    <!-- Futures Triangle -->
                    <div class="form-section">
                        <h3>4. Futures Triangle</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>Generate Futures Triangle Analysis</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Analyze the pull of the future, push of the present, and weight of history</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <button class="btn btn-ai" onclick="generateFuturesTriangle()" id="generate-triangle-btn" disabled>
                                <span>üìä</span>
                                Generate Futures Triangle
                            </button>
                        </div>
                        
                        <!-- Futures Triangle Content - UPDATE -->
                        <div id="futures-triangle-content" style="display: none;">
                            <!-- Three Forces Cards -->
                            <div class="cards-grid">
                                <div class="card">
                                    <h4>üéØ Pull of the Future</h4>
                                    <div id="triangle-future" contenteditable="true" style="min-height: 150px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                        Future visions and aspirations will appear here...
                                    </div>
                                </div>
                                <div class="card">
                                    <h4>‚ö° Push of the Present</h4>
                                    <div id="triangle-present" contenteditable="true" style="min-height: 150px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                        Current trends and drivers will appear here...
                                    </div>
                                </div>
                                <div class="card">
                                    <h4>‚öì Weight of History</h4>
                                    <div id="triangle-past" contenteditable="true" style="min-height: 150px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                        Historical constraints and legacy factors will appear here...
                                    </div>
                                </div>
                            </div>

                            <!-- Key Dynamics & Strategic Insights -->
                            <div style="margin-top: 2rem;">
                                <h3>Key Dynamics & Strategic Insights</h3>
                                <div class="cards-grid">
                                    <div class="card">
                                        <h4>‚öîÔ∏è Primary Tensions</h4>
                                        <div id="dynamics-tensions" contenteditable="true" style="min-height: 120px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                            Main conflicts between forces will appear here...
                                        </div>
                                    </div>
                                    <div class="card">
                                        <h4>ü§ù Alignment Opportunities</h4>
                                        <div id="dynamics-alignment" contenteditable="true" style="min-height: 120px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                            Where forces work together will appear here...
                                        </div>
                                    </div>
                                    <div class="card">
                                        <h4>‚ùì Critical Uncertainties</h4>
                                        <div id="dynamics-uncertainties" contenteditable="true" style="min-height: 120px; padding: 1rem; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-top: 1rem;">
                                            What remains unknown will appear here...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Save Button for Futures Triangle -->
                            <div style="margin-top: 1rem; text-align: center;">
                                <button class="btn btn-primary" onclick="saveFuturesTriangle()" id="save-triangle-btn">
                                    <span>üíæ</span>
                                    Save Futures Triangle
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="previousPhase(1)">‚Üê Back to Framing</button>
                        <button class="btn btn-primary" onclick="nextPhase(3)">Continue to Futuring ‚Üí</button>
                    </div>
                </div>

                <!-- Phase 3: Futuring -->
                <div id="phase-3" class="phase-content">       
                    <div class="content-header">
                        <h1>Phase 3: Futuring</h1>
                        <p>Develop drivers, uncertainties, narratives, and alternative scenarios</p>
                    </div>

                    <!-- Futures Triangle 2.0 Analysis -->
                    <div class="form-section">
                        <h3>1. Futures Triangle 2.0 Analysis</h3>
                        <div class="ai-card" style="margin-bottom: 1.5rem;">
                            <div class="ai-header">
                                <div>
                                    <h4>Generate Futures Triangle 2.0</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Analyze drivers, uncertainties, and narratives based on scanning data</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <button class="btn btn-ai" onclick="generateFuturesTriangle2()">
                                <span>üî∫</span>
                                Generate Analysis
                            </button>
                        </div>

                        <div id="futures-triangle-2-content" style="display: none;">
                            <!-- Visual Triangle Diagram -->
                            <div style="text-align: center; margin: 2rem 0;">
                                <!-- Just the corrected SVG section -->
                                <svg width="600" height="400" viewBox="0 0 600 400" style="max-width: 100%;">
                                    <!-- Triangle -->
                                    <path d="M300 50 L100 350 L500 350 Z" fill="#f5f7fa" stroke="#1976d2" stroke-width="2"/>
                                    
                                    <!-- Labels -->
                                    <text x="300" y="40" text-anchor="middle" font-weight="bold" font-size="16">Uncertainties</text>
                                    <text x="80" y="380" text-anchor="middle" font-weight="bold" font-size="16">Drivers</text>
                                    <text x="520" y="380" text-anchor="middle" font-weight="bold" font-size="16">Narratives</text>
                                    
                                    <!-- Arrow marker definition (moved up for proper rendering) -->
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
                                        </marker>
                                    </defs>
                                    
                                    <!-- Left arrow with repositioned text -->
                                    <path d="M150 320 Q80 250 150 180" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    <text x="90" y="250" font-size="12" text-anchor="middle">Push of</text>
                                    <text x="90" y="265" font-size="12" text-anchor="middle">the Present</text>
                                    
                                    <!-- Right arrow with repositioned text -->
                                    <path d="M450 320 Q520 250 450 180" fill="none" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    <text x="510" y="250" font-size="12" text-anchor="middle">Pull of</text>
                                    <text x="510" y="265" font-size="12" text-anchor="middle">the Future</text>
                                    
                                    <!-- Bottom curve with repositioned text -->
                                    <path d="M180 350 Q300 370 420 350" fill="none" stroke="#333" stroke-width="2"/>
                                    <text x="300" y="385" font-size="12" text-anchor="middle">Weight of the Past</text>
                                </svg>
                            </div>

                            <!-- Content Areas -->
                            <div class="cards-grid">
                                <div class="card" style="border-top: 4px solid #e74c3c;">
                                    <h4>üîÑ Drivers</h4>
                                    <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">Major factors and forces (rooted in push of present and/or weight of past)</p>
                                    <div contenteditable="true" style="min-height: 150px; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;" id="drivers-content">
                                        Click to add drivers...
                                    </div>
                                </div>
                                <div class="card" style="border-top: 4px solid #f39c12;">
                                    <h4>‚ùì Uncertainties</h4>
                                    <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">High-impact possibilities (rooted in push of present and/or pull of future)</p>
                                    <div contenteditable="true" style="min-height: 150px; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;" id="uncertainties-content">
                                        Click to add uncertainties...
                                    </div>
                                </div>
                                <div class="card" style="border-top: 4px solid #9b59b6;">
                                    <h4>üìñ Narratives</h4>
                                    <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">Common, dominant, and/or impactful stories (rooted in weight of past or pull of future)</p>
                                    <div contenteditable="true" style="min-height: 150px; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;" id="narratives-content">
                                        Click to add narratives...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Baseline Scenario Generation -->
                    <!-- Baseline Scenario Generation -->
                    <div class="form-section">
                        <h3>2. Baseline Scenario</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>Generate Baseline Scenario</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Create a continuation scenario dominated by Push of the Present and key Drivers</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <button class="btn btn-ai" onclick="generateBaselineScenario()" id="baseline-btn">
                                <span>üìà</span>
                                Generate Baseline Scenario
                            </button>
                            
                            <div class="generated-content" id="baseline-scenario-content" style="display: none; margin-top: 1rem;">
                                <!-- <button class="edit-toggle">Edit</button> -->
                                <h4 id="baseline-title"></h4>
                                <div id="baseline-text" style="margin-top: 1rem;">
                                </div>
                            </div>
                        </div>
                    </div>                     


                    <!-- Driver Outcomes -->
                    <!-- Driver Outcomes -->
                    <div class="form-section">
                        <h3>3. Driver Outcomes</h3>
                        <p style="color: #666; margin-bottom: 1rem;">Map how each driver, uncertainty, and narrative plays out across the different archetypes</p>
                        
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4>Generate Driver Outcomes</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Bend each element to the scenario archetypes</p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            <button class="btn btn-ai" onclick="generateDriverOutcomes()" id="driver-outcomes-btn">
                                <span>üéØ</span>
                                Generate Driver Outcomes
                            </button>
                        </div>

                        <!-- Results container - initially hidden -->
                        <div id="driver-outcomes-content" style="display: none; margin-top: 1.5rem;">
                            <div id="driver-outcomes-results">
                                <!-- Generated outcomes will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Alternative Scenarios -->
                    <div class="form-section">
                        <h3>4. Alternative Scenarios</h3>
                        <div class="scenario-builder">
                            <h4>Scenario Configuration</h4>
                            <p>Select which archetypes and how many scenarios to generate:</p>
                            
                            <div class="cards-grid" style="margin-top: 1rem;">
                                <div class="card">
                                    <h5>Collapse</h5>
                                    <p style="font-size: 0.875rem; color: #666;">System breakdown or dysfunction</p>
                                    <select id="collapse-count">
                                        <option value="0">0 scenarios</option>
                                        <option value="1" selected>1 scenario</option>
                                        <option value="2">2 scenarios</option>
                                    </select>
                                </div>
                                <div class="card">
                                    <h5>New Equilibrium</h5>
                                    <p style="font-size: 0.875rem; color: #666;">System adaptation and compromise</p>
                                    <select id="new-equilibrium-count">
                                        <option value="0">0 scenarios</option>
                                        <option value="1" selected>1 scenario</option>
                                        <option value="2">2 scenarios</option>
                                    </select>
                                </div>
                                <div class="card">
                                    <h5>Transformation</h5>
                                    <p style="font-size: 0.875rem; color: #666;">Fundamental system change</p>
                                    <select id="transformation-count">
                                        <option value="0">0 scenarios</option>
                                        <option value="1" selected>1 scenario</option>
                                        <option value="2">2 scenarios</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-ai" onclick="generateAlternativeScenarios()" id="alt-scenarios-btn" style="margin-top: 1.5rem;">
                                <span>üîÆ</span>
                                Generate Alternative Scenarios
                            </button>
                        </div>

                        <div id="alternative-scenarios-content" style="display: none; margin-top: 2rem;">
                            <!-- Alternative scenarios will be dynamically generated here -->
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="previousPhase(2)">‚Üê Back to Horizon Scanning</button>
                        <button class="btn btn-primary" onclick="nextPhase(4)">Continue to Visioning ‚Üí</button>
                    </div>
                </div>

                <!-- Stress Stress Test Process Start Here -->
                <!-- Add this new phase content after Phase 3 -->
                <div id="phase-policy-stress" class="phase-content">
                    <div class="content-header">
                        <h1>Policy Stress Test</h1>
                        <p>Automated analysis combining Framing, Scanning, and Futuring phases in one streamlined process</p>
                    </div>

                    <!-- Project Setup -->
                    <div class="form-section">
                        <h3>1. Project Setup</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="form-group">
                                <label for="policy-project-name">Project Name</label>
                                <input type="text" id="policy-project-name" placeholder="Enter policy project name">
                            </div>
                            <div class="form-group">
                                <label for="policy-domain-select">Domain Focus</label>
                                <select id="policy-domain-select" onchange="handlePolicyDomainSelection()">
                                    <option value="">Select domain focus...</option>
                                    <option value="food-security">Food Security & Agriculture</option>
                                    <option value="health-policy">Health Policy & Systems</option>
                                    <option value="education-reform">Education Reform</option>
                                    <option value="economic-development">Economic Development</option>
                                    <option value="climate-adaptation">Climate Adaptation</option>
                                    <option value="digital-governance">Digital Governance</option>
                                    <option value="social-protection">Social Protection</option>
                                    <option value="infrastructure">Infrastructure Development</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="policy-other-domain" style="display: none;">
                            <label for="policy-other-domain-input">Other Domain</label>
                            <input type="text" id="policy-other-domain-input" placeholder="Specify domain">
                        </div>
                    </div>

                    <!-- Document Upload -->
                    <div class="form-section">
                        <h3>2. Document Upload</h3>
                        <div class="upload-area" onclick="document.getElementById('policy-document').click()">
                            <div class="upload-icon">üìÑ</div>
                            <p><strong>Upload Policy Document</strong></p>
                            <p style="font-size: 0.9rem; color: #666;">
                                Supports PDF, Word, PowerPoint, or text files<br>
                                Policy papers, white papers, strategy documents
                            </p>
                            <input type="file" id="policy-document" style="display: none;" 
                                accept=".pdf,.doc,.docx,.ppt,.pptx,.txt">
                        </div>
                        <div id="policy-upload-status" style="margin-top: 1rem;">
                            <div class="signal-card strong">
                                <h4 id="policy-upload-title">üìÑ Ready to Analyze</h4>
                                <p id="policy-filename">Domain-based analysis available. Upload document for enhanced insights (optional)</p>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                    <button class="btn btn-secondary" onclick="removePolicyDocument()" id="remove-doc-btn" style="display: none;">Remove Document</button>
                                    <button class="btn btn-ai" onclick="runPolicyStressTest()" id="run-stress-test-btn">
                                        ‚ö° Run Stress Test
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Section -->
                    <div class="form-section" id="policy-processing-section" style="display: none;">
                        <h3>3. Analysis Processing</h3>
                        <div class="ai-card">
                            <div class="ai-header">
                                <div>
                                    <h4 id="processing-title">Running Policy Stress Test...</h4>
                                    <p style="font-size: 0.9rem; color: #666;" id="processing-description">
                                        Analyzing document and generating foresight insights
                                    </p>
                                </div>
                                <span class="ai-badge">AI Assistant</span>
                            </div>
                            
                            <!-- Progress Steps -->
                            <div class="progress-steps-grid">
                                <div class="progress-step active" id="step-1">
                                    <span class="step-icon">üìÑ</span>
                                    <span class="step-text">Parsing Document</span>
                                </div>
                                <div class="progress-step" id="step-2">
                                    <span class="step-icon">üîç</span>
                                    <span class="step-text">Extracting Information</span>
                                </div>
                                <div class="progress-step" id="step-3">
                                    <span class="step-icon">üéØ</span>
                                    <span class="step-text">Running Framing</span>
                                </div>
                                <div class="progress-step" id="step-4">
                                    <span class="step-icon">üì°</span>
                                    <span class="step-text">Horizon Scanning</span>
                                </div>
                                <div class="progress-step" id="step-5">
                                    <span class="step-icon">üîÆ</span>
                                    <span class="step-text">Futuring Analysis</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Results Sections -->
                    <div id="policy-results-container" style="display: none;">
                        
                        <!-- Framing Results -->
                        <div class="form-section">
                            <h3>4. Framing Analysis Results</h3>
                            <div class="ai-card">
                                <div class="ai-header">
                                    <div>
                                        <h4>Domain Map Generated</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Central domain and sub-domains identified</p>
                                    </div>
                                    <span class="ai-badge">Phase 1</span>
                                </div>
                                
                                <!-- Domain Map Visual -->
                                <div class="generated-content" id="policy-domain-map">
                                    <div style="text-align: center; margin: 2rem 0;">
                                        <div style="background: #1976d2; color: white; padding: 1rem 2rem; border-radius: 8px; display: inline-block; margin-bottom: 1.5rem;">
                                            <strong id="policy-central-domain">Policy Domain</strong>
                                        </div>
                                        <div class="cards-grid" id="policy-sub-domains">
                                            <!-- Sub-domains will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scanning Results -->
                        <div class="form-section">
                            <h3>5. Horizon Scanning Results</h3>
                            
                            <!-- Signals -->
                            <div class="ai-card" style="margin-bottom: 1.5rem;">
                                <div class="ai-header">
                                    <div>
                                        <h4>Signals Analysis</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Strong and weak signals identified</p>
                                    </div>
                                    <span class="ai-badge">Phase 2</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                        <div>
                                            <h5 style="color: #d32f2f; margin-bottom: 1rem;">üî¥ Strong Signals</h5>
                                            <div id="policy-strong-signals">
                                                <!-- Strong signals will be populated here -->
                                            </div>
                                        </div>
                                        <div>
                                            <h5 style="color: #f57c00; margin-bottom: 1rem;">üü° Weak Signals</h5>
                                            <div id="policy-weak-signals">
                                                <!-- Weak signals will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- STEEPV Analysis -->
                            <div class="ai-card" style="margin-bottom: 1.5rem;">
                                <div class="ai-header">
                                    <div>
                                        <h4>STEEPV Analysis</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Systematic analysis across all dimensions</p>
                                    </div>
                                    <span class="ai-badge">Phase 2</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div class="matrix-container">
                                        <div class="matrix-grid" style="grid-template-columns: repeat(2, 1fr);">
                                            <div class="matrix-cell matrix-header"><strong>S</strong>ocial</div>
                                            <div class="matrix-cell" id="policy-steepv-social">Social factors...</div>
                                            
                                            <div class="matrix-cell matrix-header"><strong>T</strong>echnological</div>
                                            <div class="matrix-cell" id="policy-steepv-tech">Technological factors...</div>
                                            
                                            <div class="matrix-cell matrix-header"><strong>E</strong>conomic</div>
                                            <div class="matrix-cell" id="policy-steepv-economic">Economic factors...</div>
                                            
                                            <div class="matrix-cell matrix-header"><strong>E</strong>nvironmental</div>
                                            <div class="matrix-cell" id="policy-steepv-env">Environmental factors...</div>
                                            
                                            <div class="matrix-cell matrix-header"><strong>P</strong>olitical</div>
                                            <div class="matrix-cell" id="policy-steepv-political">Political factors...</div>
                                            
                                            <div class="matrix-cell matrix-header"><strong>V</strong>alues</div>
                                            <div class="matrix-cell" id="policy-steepv-values">Values factors...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Futures Triangle -->
                            <!-- Futures Triangle -->
                            <div class="ai-card">
                                <div class="ai-header">
                                    <div>
                                        <h4>Futures Triangle</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Three forces shaping the future</p>
                                    </div>
                                    <span class="ai-badge">Phase 2</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div class="cards-grid">
                                        <div class="card" style="border-top: 4px solid #2ecc71;">
                                            <h4>üéØ Pull of the Future</h4>
                                            <div style="margin-top: 1rem;">
                                                <div><strong>Emerging Issues:</strong> <span id="policy-ft-emerging-issues"></span></div>
                                                <div><strong>Visions And Aspirations:</strong> <span id="policy-ft-visions-aspirations"></span></div>
                                                <div><strong>Weak Signals:</strong> <span id="policy-ft-weak-signals"></span></div>
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #3498db;">
                                            <h4>‚û°Ô∏è Push of the Present</h4>
                                            <div style="margin-top: 1rem;">
                                                <div><strong>Current Trends:</strong> <span id="policy-ft-current-trends"></span></div>
                                                <div><strong>Strong Drivers:</strong> <span id="policy-ft-strong-drivers"></span></div>
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #e74c3c;">
                                            <h4>‚öì Weight of History</h4>
                                            <div style="margin-top: 1rem;">
                                                <div><strong>Barriers And Inertia:</strong> <span id="policy-ft-barriers-inertia"></span></div>
                                                <div><strong>Values To Preserve:</strong> <span id="policy-ft-values-preserve"></span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Key Dynamics & Strategic Insights -->
                                    <div style="margin-top: 2rem;">
                                        <h5 style="color: #1976d2; margin-bottom: 1rem;">Key Dynamics & Strategic Insights</h5>
                                        <div class="cards-grid">
                                            <div class="card" style="border-top: 3px solid #9c27b0;">
                                                <h5>Primary Tensions</h5>
                                                <div id="policy-ft-primary-tensions" style="margin-top: 0.5rem;"></div>
                                            </div>
                                            <div class="card" style="border-top: 3px solid #4caf50;">
                                                <h5>Alignment Opportunities</h5>
                                                <div id="policy-ft-alignment-opportunities" style="margin-top: 0.5rem;"></div>
                                            </div>
                                            <div class="card" style="border-top: 3px solid #ff5722;">
                                                <h5>Critical Uncertainties</h5>
                                                <div id="policy-ft-critical-uncertainties" style="margin-top: 0.5rem;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Futuring Results -->
                        <div class="form-section">
                            <h3>6. Futuring Analysis Results</h3>
                            
                            <!-- Futures Triangle 2.0 -->
                            <div class="ai-card" style="margin-bottom: 1.5rem;">
                                <div class="ai-header">
                                    <div>
                                        <h4>Futures Triangle 2.0</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Drivers, uncertainties, and narratives</p>
                                    </div>
                                    <span class="ai-badge">Phase 3</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div class="cards-grid">
                                        <div class="card" style="border-top: 4px solid #e74c3c;">
                                            <h4>üîÑ Drivers</h4>
                                            <p style="font-size: 0.875rem; color: #666;">Major factors and forces</p>
                                            <div id="policy-ft2-drivers" style="margin-top: 1rem;">
                                                <!-- Drivers content -->
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #f39c12;">
                                            <h4>‚ùì Uncertainties</h4>
                                            <p style="font-size: 0.875rem; color: #666;">High-impact possibilities</p>
                                            <div id="policy-ft2-uncertainties" style="margin-top: 1rem;">
                                                <!-- Uncertainties content -->
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #9b59b6;">
                                            <h4>üìñ Narratives</h4>
                                            <p style="font-size: 0.875rem; color: #666;">Dominant stories</p>
                                            <div id="policy-ft2-narratives" style="margin-top: 1rem;">
                                                <!-- Narratives content -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Baseline Scenario -->
                            <div class="ai-card" style="margin-bottom: 1.5rem;">
                                <div class="ai-header">
                                    <div>
                                        <h4>Baseline Scenario</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Continuation scenario</p>
                                    </div>
                                    <span class="ai-badge">Phase 3</span>
                                </div>
                                
                                <div class="generated-content">
                                    <h5 id="policy-baseline-title">Baseline Scenario Title</h5>
                                    <div id="policy-baseline-content" style="margin-top: 1rem;">
                                        <!-- Baseline scenario content -->
                                    </div>
                                </div>
                            </div>

                            <!-- Driver Outcomes -->
                            <div class="ai-card" style="margin-bottom: 1.5rem;">
                                <div class="ai-header">
                                    <div>
                                        <h4>Driver Outcomes</h4>
                                        <p style="font-size: 0.9rem; color: #666;">How drivers play out across different archetypes</p>
                                    </div>
                                    <span class="ai-badge">Phase 3</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div class="cards-grid">
                                        <div class="card" style="border-top: 4px solid #f44336;">
                                            <h4>üìâ Collapse/Decline</h4>
                                            <div id="policy-driver-collapse" style="margin-top: 1rem;">
                                                <!-- Collapse driver outcomes -->
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #ff9800;">
                                            <h4>‚öñÔ∏è New Equilibrium</h4>
                                            <div id="policy-driver-equilibrium" style="margin-top: 1rem;">
                                                <!-- New Equilibrium driver outcomes -->
                                            </div>
                                        </div>
                                        <div class="card" style="border-top: 4px solid #4caf50;">
                                            <h4>üöÄ Transformation</h4>
                                            <div id="policy-driver-transformation" style="margin-top: 1rem;">
                                                <!-- Transformation driver outcomes -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Alternative Scenarios -->
                            <div class="ai-card">
                                <div class="ai-header">
                                    <div>
                                        <h4>Alternative Scenarios</h4>
                                        <p style="font-size: 0.9rem; color: #666;">Different future possibilities</p>
                                    </div>
                                    <span class="ai-badge">Phase 3</span>
                                </div>
                                
                                <div class="generated-content">
                                    <div id="policy-alternative-scenarios">
                                        <!-- Alternative scenarios will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Section -->
                        <div class="form-section">
                            <h3>7. Export Results</h3>
                            <div class="cards-grid">
                                <div class="card">
                                    <h4>üìÑ PDF Report</h4>
                                    <p>Professional formatted report with all findings</p>
                                    <button class="btn btn-success" style="margin-top: 1rem;">Export PDF</button>
                                </div>
                                <div class="card">
                                    <h4>üìä Data Package</h4>
                                    <p>Raw data, analysis files, and visualizations</p>
                                    <button class="btn btn-success" style="margin-top: 1rem;">Export Data</button>
                                </div>
                                <div class="card">
                                    <h4>üé• Presentation</h4>
                                    <p>Slide deck for stakeholder presentations</p>
                                    <button class="btn btn-success" style="margin-top: 1rem;">Export Slides</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <!-- <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchToPhase(6)">‚Üê Back to Adapting</button>
                        <button class="btn btn-success">Complete Analysis ‚úì</button>
                    </div> -->
                    <!-- Navigation Buttons -->
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="switchToPhase(1)">‚Üê Back to Main Flow</button>
                        <button class="btn btn-success" onclick="restartPolicyStressTest()">Start New Analysis</button>
                    </div>
                </div>
            </main>
    <script>
        // Global state
        let currentPhase = 1;
        let completedPhases = [];
        let uploadedFiles = {
            domainMap: null,
            documents: [],
            signals: [],
            interviews: []
        };
        let lastSignalsData = null;
        let savedSTEEPVData = null;
        let savedFuturesTriangleData = null;
        let savedPhase1Data = null;

        // Phase Navigation
        document.querySelectorAll('.phase-item').forEach(item => {
            item.addEventListener('click', function() {
                const phase = parseInt(this.dataset.phase);
                switchToPhase(phase);
            });
        });

        function switchToPhase(phase) {
            // Hide all phases
            document.querySelectorAll('.phase-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected phase
            document.getElementById(`phase-${phase}`).classList.add('active');

            // Update sidebar
            document.querySelectorAll('.phase-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.phase) === phase) {
                    item.classList.add('active');
                }
            });

            currentPhase = phase;
            updateProgress();
        }

        // function switchToPhase(phase) {
        //     // Hide all phases including policy stress
        //     document.querySelectorAll('.phase-content').forEach(content => {
        //         content.classList.remove('active');
        //     });

        //     // Show selected phase
        //     if (phase === 'policy-stress') {
        //         document.getElementById('phase-policy-stress').classList.add('active');
        //         // Update sidebar to show no active regular phase
        //         document.querySelectorAll('.phase-item').forEach(item => {
        //             item.classList.remove('active');
        //         });
        //     } else {
        //         document.getElementById(`phase-${phase}`).classList.add('active');
        //         // Update sidebar
        //         document.querySelectorAll('.phase-item').forEach(item => {
        //             item.classList.remove('active');
        //             if (parseInt(item.dataset.phase) === phase) {
        //                 item.classList.add('active');
        //             }
        //         });
        //         currentPhase = phase;
        //     }
            
        //     updateProgress();
        // }


        // UPDATE: Modified nextPhase function to pass saved data
        function nextPhase(phase) {
            // Mark current phase as completed
            if (!completedPhases.includes(currentPhase)) {
                completedPhases.push(currentPhase);
                document.querySelector(`.phase-item[data-phase="${currentPhase}"]`).classList.add('completed');
            }
            
            // If moving from Phase 2 (Horizon Scanning) to Phase 3 (Futuring)
            if (currentPhase === 2 && phase === 3) {
                // Pass saved data to next phase
                if (savedSTEEPVData || savedFuturesTriangleData) {
                    // Store in global variables or local storage for Phase 3 to use
                    localStorage.setItem('phase2_steepv_data', JSON.stringify(savedSTEEPVData || {}));
                    localStorage.setItem('phase2_futures_triangle_data', JSON.stringify(savedFuturesTriangleData || {}));
                }
            }
            
            switchToPhase(phase);
        }

        // ADD: Function to get saved data from Phase 2
        function getPhase2SavedData() {
            return {
                steepv_data: savedSTEEPVData || JSON.parse(localStorage.getItem('phase2_steepv_data') || '{}'),
                futures_triangle_data: savedFuturesTriangleData || JSON.parse(localStorage.getItem('phase2_futures_triangle_data') || '{}')
            };
        }

        function previousPhase(phase) {
            switchToPhase(phase);
        }

        function updateProgress() {
            const totalPhases = 6;
            const progress = (completedPhases.length / totalPhases) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress);
        }

        // Domain Selection Handler
        function handleDomainSelection() {
            const select = document.getElementById('domain-select');
            const newDomainInput = document.getElementById('new-domain-input');
            
            if (select.value === 'new') {
                newDomainInput.style.display = 'block';
            } else {
                newDomainInput.style.display = 'none';
            }
        }

        // File Upload Handlers
        document.getElementById('domain-map-file').addEventListener('change', function(e) {
            const files = Array.from(e.target.files || []);
            if (files.length > 0) {
                uploadedFiles.domainMap = files[0];
                uploadedFiles.documents = files; // treat as project documents
                document.getElementById('domain-map-filename').textContent = files[0].name;
                document.getElementById('domain-map-upload-status').style.display = 'block';
                document.getElementById('refine-btn').style.display = 'inline-flex';
            }
        });

        function removeDomainMapUpload() {
            uploadedFiles.domainMap = null;
            uploadedFiles.documents = [];
            document.getElementById('domain-map-upload-status').style.display = 'none';
            document.getElementById('refine-btn').style.display = 'none';
            document.getElementById('domain-map-file').value = '';
        }

        document.getElementById('interview-files').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            uploadedFiles.interviews = uploadedFiles.interviews.concat(files);
            updateInterviewList();
        });

        function updateInterviewList() {
            const listContainer = document.getElementById('interview-upload-list');
            if (uploadedFiles.interviews.length > 0) {
                listContainer.innerHTML = uploadedFiles.interviews.map((file, index) => `
                    <div class="signal-card" style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>üìÑ ${file.name}</span>
                            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                    onclick="removeInterviewFile(${index})">Remove</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('analyze-interviews-btn').disabled = false;
            } else {
                listContainer.innerHTML = '';
                document.getElementById('analyze-interviews-btn').disabled = true;
            }
        }

        function removeInterviewFile(index) {
            uploadedFiles.interviews.splice(index, 1);
            updateInterviewList();
        }

        // Scanning Phase File Uploads
        document.getElementById('signals-upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            uploadedFiles.signals = uploadedFiles.signals || [];
            uploadedFiles.signals = uploadedFiles.signals.concat(files);
            updateSignalsList();
        });

        function updateSignalsList() {
            const listContainer = document.getElementById('signals-upload-list');
            if (uploadedFiles.signals && uploadedFiles.signals.length > 0) {
                listContainer.innerHTML = uploadedFiles.signals.map((file, index) => `
                    <div class="signal-card" style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>üìÑ ${file.name}</span>
                            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                    onclick="removeSignalFile(${index})">Remove</button>
                        </div>
                    </div>
                `).join('');
            } else {
                listContainer.innerHTML = '';
            }
        }

        function removeSignalFile(index) {
            uploadedFiles.signals.splice(index, 1);
            updateSignalsList();
        }

        // Add this function to your JavaScript
        function showOutcomeTab(tabName) {
            // Hide all outcome content
            document.querySelectorAll('.outcome-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content
            const contentId = `outcomes-${tabName}`;
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                contentElement.classList.add('active');
            }
            
            // Activate clicked tab
            event.target.classList.add('active');
        }




        // Policy Stress Functions
        // Policy Stress specific functions
        function handlePolicyDomainSelection() {
            const select = document.getElementById('policy-domain-select');
            const otherDomainDiv = document.getElementById('policy-other-domain');
            
            if (select.value === 'other') {
                otherDomainDiv.style.display = 'block';
            } else {
                otherDomainDiv.style.display = 'none';
            }
        }

        // File upload handler for policy document
        // document.getElementById('policy-document').addEventListener('change', function(e) {
        //     const file = e.target.files[0];
        //     if (file) {
        //         document.getElementById('policy-filename').textContent = file.name;
        //         document.getElementById('policy-upload-status').style.display = 'block';
        //     }
        // });

        document.getElementById('policy-document').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('policy-upload-title').innerHTML = '‚úÖ Document Uploaded';
                document.getElementById('policy-filename').textContent = file.name + ' - Enhanced analysis will include document insights';
                document.getElementById('remove-doc-btn').style.display = 'inline-block';
            }
        });

        function removePolicyDocument() {
            document.getElementById('policy-document').value = '';
            document.getElementById('policy-upload-status').style.display = 'none';
            document.getElementById('policy-processing-section').style.display = 'none';
            document.getElementById('policy-results-container').style.display = 'none';
        }

        function runPolicyStressTest() {
            const projectName = document.getElementById('policy-project-name').value;
            const domain = document.getElementById('policy-domain-select').value;
            const file = document.getElementById('policy-document').files[0];
            
            if (!projectName || !domain || !file) {
                alert('Please fill all fields and upload a document');
                return;
            }
            
            // Show processing section
            document.getElementById('policy-processing-section').style.display = 'block';
            document.getElementById('run-stress-test-btn').disabled = true;
            document.getElementById('run-stress-test-btn').innerHTML = '‚è≥ Processing...';
            
            // Simulate progress steps
            const steps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
            let currentStep = 0;
            
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    // Mark previous step as completed
                    if (currentStep > 0) {
                        document.getElementById(steps[currentStep - 1]).classList.remove('active');
                        document.getElementById(steps[currentStep - 1]).classList.add('completed');
                    }
                    // Activate current step
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(progressInterval);
                    // Complete processing and show results
                    document.getElementById(steps[steps.length - 1]).classList.remove('active');
                    document.getElementById(steps[steps.length - 1]).classList.add('completed');
                    
                    setTimeout(() => {
                        showPolicyResults(domain);
                    }, 1000);
                }
            }, 2000);
        }

        function showPolicyResults(domain) {
            // Hide processing section
            document.getElementById('processing-title').textContent = 'Analysis Complete!';
            document.getElementById('processing-description').textContent = 'All phases have been processed successfully';
            
            // Show results
            document.getElementById('policy-results-container').style.display = 'block';
            
            // Generate sample results based on domain
            generatePolicyResults(domain);
        }

        function generatePolicyResults(domain) {
            // Sample data based on domain
            const domainData = {
                'food-security': {
                    centralDomain: 'Food Security & Agricultural Resilience Policy Framework',
                    subDomains: ['Production Systems', 'Market Access', 'Climate Adaptation', 'Nutrition & Health'],
                    strongSignals: ['Rising global food prices', 'Climate change impacts on agriculture', 'Digital agriculture adoption'],
                    weakSignals: ['Vertical farming technologies', 'Gene-edited crop varieties', 'Blockchain supply chains'],
                    baselineTitle: 'Gradual Agricultural Policy Implementation'
                },
                // Add more domains as needed
            };
            
            const data = domainData[domain] || domainData['food-security'];
            
            // Populate Framing Results
            document.getElementById('policy-central-domain').textContent = data.centralDomain;
            
            const subDomainsHtml = data.subDomains.map(subDomain => 
                `<div class="card" style="text-align: center; padding: 1rem;">
                    <h5 style="color: #1976d2; margin: 0;">${subDomain}</h5>
                </div>`
            ).join('');
            document.getElementById('policy-sub-domains').innerHTML = subDomainsHtml;
            
            // Populate Scanning Results
            const strongSignalsHtml = data.strongSignals.map(signal => 
                `<div class="signal-item strong-signal">${signal}</div>`
            ).join('');
            document.getElementById('policy-strong-signals').innerHTML = strongSignalsHtml;
            
            const weakSignalsHtml = data.weakSignals.map(signal => 
                `<div class="signal-item weak-signal">${signal}</div>`
            ).join('');
            document.getElementById('policy-weak-signals').innerHTML = weakSignalsHtml;
            
            // STEEPV Results
            document.getElementById('policy-steepv-social').textContent = 'Demographic trends, social acceptance, stakeholder engagement';
            document.getElementById('policy-steepv-tech').textContent = 'Digital transformation, automation, emerging technologies';
            document.getElementById('policy-steepv-economic').textContent = 'Budget allocations, economic impacts, cost-benefit ratios';
            document.getElementById('policy-steepv-env').textContent = 'Environmental regulations, sustainability requirements, climate factors';
            document.getElementById('policy-steepv-political').textContent = 'Political support, regulatory frameworks, governance structures';
            document.getElementById('policy-steepv-values').textContent = 'Cultural values, ethical considerations, public acceptance';
            
            // Futures Triangle
            // Update Futures Triangle with new structure
            document.getElementById('policy-ft-emerging-issues').textContent = 'Policy implementation gaps, coordination challenges';
            document.getElementById('policy-ft-visions-aspirations').textContent = 'Sustainable development goals, policy success vision';
            document.getElementById('policy-ft-weak-signals').textContent = data.weakSignals.join(', ');
            document.getElementById('policy-ft-current-trends').textContent = 'Current policy trends, implementation patterns';
            document.getElementById('policy-ft-strong-drivers').textContent = 'Political priorities, budget constraints, stakeholder pressures';
            document.getElementById('policy-ft-barriers-inertia').textContent = 'Institutional inertia, resource limitations, political resistance';
            document.getElementById('policy-ft-values-preserve').textContent = 'Core policy principles, cultural considerations, stakeholder values';

            // Key Dynamics & Strategic Insights
            document.getElementById('policy-ft-primary-tensions').textContent = 'Resource allocation vs. implementation speed, stakeholder interests vs. efficiency';
            document.getElementById('policy-ft-alignment-opportunities').textContent = 'Cross-sector collaboration, shared objectives, synergistic policies';
            document.getElementById('policy-ft-critical-uncertainties').textContent = 'Political continuity, economic stability, stakeholder cooperation';

            // Driver Outcomes
            document.getElementById('policy-driver-collapse').innerHTML = '<p>System breakdown due to resource constraints, institutional failures, and external pressures leading to crisis management mode.</p>';
            document.getElementById('policy-driver-equilibrium').innerHTML = '<p>Gradual adaptation and moderate progress through stakeholder negotiation and incremental improvements.</p>';
            document.getElementById('policy-driver-transformation').innerHTML = '<p>Breakthrough innovations and strong leadership enable rapid positive change and system restructuring.</p>';
            
            // Futures Triangle 2.0
            document.getElementById('policy-ft2-drivers').innerHTML = `
                <ul style="font-size: 0.9rem;">
                    <li>Policy implementation capacity</li>
                    <li>Budget allocation priorities</li>
                    <li>Stakeholder coordination levels</li>
                    <li>External economic pressures</li>
                </ul>
            `;
            
            document.getElementById('policy-ft2-uncertainties').innerHTML = `
                <ul style="font-size: 0.9rem;">
                    <li>Political continuity and support</li>
                    <li>Technology adoption rates</li>
                    <li>International cooperation levels</li>
                    <li>Economic stability factors</li>
                </ul>
            `;
            
            document.getElementById('policy-ft2-narratives').innerHTML = `
                <ul style="font-size: 0.9rem;">
                    <li>Modernization through policy reform</li>
                    <li>Sustainable development priorities</li>
                    <li>Evidence-based policy making</li>
                    <li>Stakeholder engagement importance</li>
                </ul>
            `;
            
            // Baseline Scenario
            document.getElementById('policy-baseline-title').textContent = data.baselineTitle;
            document.getElementById('policy-baseline-content').innerHTML = `
                <p>This scenario represents the most likely policy implementation path based on current trajectories and available resources.</p>
                <p><strong>Key characteristics:</strong></p>
                <ul>
                    <li>Gradual policy implementation with moderate resources</li>
                    <li>Steady progress on key performance indicators</li>
                    <li>Limited disruption from external factors</li>
                    <li>Maintained institutional frameworks</li>
                </ul>
            `;
            
            // Alternative Scenarios
            const alternativeScenarios = [
                {
                    type: 'collapse',
                    title: 'Policy Implementation Crisis',
                    description: 'Severe resource constraints and institutional failures lead to policy breakdown and emergency restructuring measures.'
                },
                {
                    type: 'equilibrium', 
                    title: 'Adaptive Policy Framework',
                    description: 'Policies adapt to new realities through stakeholder negotiation and resource optimization, achieving moderate success.'
                },
                {
                    type: 'transformation',
                    title: 'Policy Innovation Breakthrough',
                    description: 'Revolutionary approaches and strong political support enable dramatic policy success and system transformation.'
                }
            ];
            
            const scenariosHtml = alternativeScenarios.map(scenario => `
                <div class="scenario-item">
                    <span class="scenario-type-badge scenario-${scenario.type}">
                        ${scenario.type.toUpperCase()}
                    </span>
                    <h5 style="margin: 0.75rem 0 0.5rem 0;">${scenario.title}</h5>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">${scenario.description}</p>
                </div>
            `).join('');
            
            document.getElementById('policy-alternative-scenarios').innerHTML = scenariosHtml;
        }

        function restartPolicyStressTest() {
            // Reset all forms and hide results
            document.getElementById('policy-project-name').value = '';
            document.getElementById('policy-domain-select').value = '';
            document.getElementById('policy-other-domain').style.display = 'none';
            document.getElementById('policy-document').value = '';
            document.getElementById('policy-upload-status').style.display = 'none';
            document.getElementById('policy-processing-section').style.display = 'none';
            document.getElementById('policy-results-container').style.display = 'none';
            document.getElementById('run-stress-test-btn').disabled = false;
            document.getElementById('run-stress-test-btn').innerHTML = '‚ö° Run Stress Test';
            
            // Reset all progress steps
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
        }

        function handlePolicyDomainSelection() {
            const select = document.getElementById('policy-domain-select');
            const otherDomainDiv = document.getElementById('policy-other-domain');
            const uploadStatus = document.getElementById('policy-upload-status');
            
            if (select.value === 'other') {
                otherDomainDiv.style.display = 'block';
            } else {
                otherDomainDiv.style.display = 'none';
            }
            
            // Show upload status when domain is selected
            if (select.value) {
                uploadStatus.style.display = 'block';
            }
        }




        // API Functions
        async function generateDomainMap() {
            const button = event.target.closest('.btn-ai');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;
            const out = document.getElementById('domain-map-content');
            try {
                const projectName = document.getElementById('project-name').value.trim();
                const domain = resolveFinalDomain();
                if (!projectName) throw new Error('Please enter project name');
                if (!domain) throw new Error('Please select or enter domain');
                const form = new FormData();
                form.append('project_name', projectName);
                form.append('final_domain', domain);
                (uploadedFiles.documents || []).forEach(f => form.append('documents', f));
                const res = await fetch('/api/generate-domain-map', { method: 'POST', body: form });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate domain map');
                const dm = data.domain_map || {};
                out.style.display = 'block';
                out.innerHTML = renderDomainMap(dm);

                // Add these lines after successful rendering
                window.savedDomainMapData = dm; // Store the domain map data
                document.getElementById('mindmap-btn').style.display = 'inline-block'; // Show mind map button
                // document.getElementById('refine-btn').style.display = 'inline-block'; // Also show refine button
            } catch (err) {
                alert(err.message || 'Error generating domain map');
            } finally {
                button.innerHTML = '<span>ü§ñ</span> Generate Domain Map';
                button.disabled = false;
            }
        }

        async function refineDomainMap() {
            const button = document.getElementById('refine-btn');
            button.innerHTML = '<span>‚è≥</span> Refining...';
            button.disabled = true;
            
            // For now, just re-generate the domain map
            try {
                await generateDomainMap();
            } catch (err) {
                console.error('Error refining domain map:', err);
            } finally {
                button.innerHTML = '<span>üîß</span> Refine Existing Map';
                button.disabled = false;
            }
        }

        async function generateMindMap() {
            const button = document.getElementById('mindmap-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please generate domain map first');

                // Get the current domain map data
                const domainMapData = window.savedDomainMapData || {};
                
                const form = new FormData();
                form.append('domain_map', JSON.stringify(domainMapData));
                form.append('domain', domain);

                const res = await fetch('/api/generate-mindmap', {
                    method: 'POST',
                    body: form
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate mind map');

                // Show mind map content
                document.getElementById('mindmap-content').style.display = 'block';
                renderMindMap(data.mindmap_data);

            } catch (err) {
                alert(err.message || 'Error generating mind map');
            } finally {
                button.innerHTML = '<span>üß†</span> Generate Mind Map';
                button.disabled = false;
            }
        }

        async function analyzeInterviews() {
            const button = document.getElementById('analyze-interviews-btn');
            const container = document.getElementById('interview-analysis-content');
            const wrap = document.getElementById('interview-analysis');
            button.innerHTML = '<span>‚è≥</span> Analyzing...';
            button.disabled = true;

            try {
                const form = new FormData();
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please select or enter domain in Phase 1');
                form.append('domain', domain);
                (uploadedFiles.interviews || []).forEach(f => form.append('interviews', f));

                const res = await fetch('/api/analyze-interviews', { method: 'POST', body: form });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to analyze');

                const analysis = data.interview_analysis || {};
                wrap.style.display = 'block';
                container.innerHTML = renderInterviewAnalysis(analysis);
            } catch (err) {
                alert(err.message || 'Error analyzing interviews');
            } finally {
                button.innerHTML = '<span>üìä</span> Analyze Interview Data';
                button.disabled = false;
            }
        }

        // UPDATE 1: In generateSignals() function - around line 480
        async function generateSignals() {
            const button = event.target.closest('.btn-ai');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const form = new FormData();
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set project name and domain in Phase 1');
                form.append('domain', domain);
                
                // UPDATED: Include ALL document types with proper field names
                (uploadedFiles.documents || []).forEach(f => form.append('documents', f));
                (uploadedFiles.signals || []).forEach(f => form.append('signals', f));
                (uploadedFiles.interviews || []).forEach(f => form.append('interviews', f));
                
                // ADD: Also include domain map if uploaded separately
                if (uploadedFiles.domainMap) {
                    form.append('domain_map', uploadedFiles.domainMap);
                }

                const res = await fetch('/api/generate-signals', { method: 'POST', body: form });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate signals');

                lastSignalsData = data.signals_data || {};
                
                // Enable buttons and show signals section
                document.getElementById('ai-suggestions-btn').disabled = false;
                document.getElementById('generate-steepv-btn').disabled = false;
                document.getElementById('signals-section').style.display = 'block';
                
                renderSignalsTabs(lastSignalsData);
            } catch (err) {
                alert(err.message || 'Error generating signals');
            } finally {
                button.innerHTML = '<span>üîç</span> Generate Strong & Weak Signals';
                button.disabled = false;
            }
        }

        async function generateAISuggestions() {
            const button = event.target.closest('.btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;
            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                if (!lastSignalsData) throw new Error('Generate signals first');
                const res = await fetch('/api/generate-ai-suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, signals_data: lastSignalsData })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate suggestions');
                const list = Array.isArray(data.suggestions) ? data.suggestions : [];
                document.getElementById('signals-ai').style.display = 'block';
                document.getElementById('signals-ai').innerHTML = list.map(renderAISuggestion).join('') || '<p>No suggestions</p>';
            } catch (err) {
                alert(err.message || 'Error generating AI suggestions');
            } finally {
                button.innerHTML = '<span>üí°</span> Generate AI Suggestions';
                button.disabled = false;
            }
        }

        // UPDATE 2: In generateSTEEPV() function - around line 550
        async function generateSTEEPV() {
            const button = document.getElementById('generate-steepv-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                if (!lastSignalsData) throw new Error('Generate signals first');

                const form = new FormData();
                form.append('domain', domain);
                form.append('signals_data', JSON.stringify(lastSignalsData));
                
                // UPDATED: Include ALL document types
                (uploadedFiles.documents || []).forEach(f => form.append('documents', f));
                (uploadedFiles.signals || []).forEach(f => form.append('signals', f));
                (uploadedFiles.interviews || []).forEach(f => form.append('interviews', f));
                
                // ADD: Include domain map
                if (uploadedFiles.domainMap) {
                    form.append('domain_map', uploadedFiles.domainMap);
                }

                const res = await fetch('/api/generate-steepv', { method: 'POST', body: form });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate STEEPV analysis');

                const steepv = data.steepv || {};
                document.getElementById('steepv-content').style.display = 'block';
                document.getElementById('generate-triangle-btn').disabled = false;
                renderSTEEPV(steepv);
            } catch (err) {
                alert(err.message || 'Error generating STEEPV analysis');
            } finally {
                button.innerHTML = '<span>üìä</span> Generate STEEPV Analysis';
                button.disabled = false;
            }
        }


        // Tab Switching for Signals
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab')) {
                const tab = e.target;
                const group = tab.parentElement;
                group.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const type = tab.dataset.tab;
                document.getElementById('signals-strong').style.display = (type === 'strong') ? 'block' : 'none';
                document.getElementById('signals-weak').style.display = (type === 'weak') ? 'block' : 'none';
                document.getElementById('signals-ai').style.display = (type === 'ai-suggestions') ? 'block' : 'none';
            }
        });

        // UPDATE 3: In generateFuturesTriangle() function - around line 620
        async function generateFuturesTriangle() {
            const button = document.getElementById('generate-triangle-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                if (!lastSignalsData) throw new Error('Generate signals first');

                // Get STEEPV data from the rendered content
                const steepvData = {};
                const categories = ['social', 'technological', 'economic', 'environmental', 'political', 'values'];
                categories.forEach(cat => {
                    const element = document.getElementById(`steepv-${cat}`);
                    steepvData[cat] = element ? element.innerHTML : '';
                });

                // UPDATED: Include comprehensive document context
                const payload = {
                    domain,
                    signals_data: lastSignalsData,
                    steepv_data: steepvData,
                    document_context: {
                        has_documents: (uploadedFiles.documents || []).length > 0,
                        has_interviews: (uploadedFiles.interviews || []).length > 0,
                        has_signals: (uploadedFiles.signals || []).length > 0,
                        has_domain_map: !!uploadedFiles.domainMap
                    }
                };

                // ADD: Include file data in the request
                const form = new FormData();
                form.append('request_data', JSON.stringify(payload));
                
                // Include all document types
                (uploadedFiles.documents || []).forEach(f => form.append('documents', f));
                (uploadedFiles.signals || []).forEach(f => form.append('signals', f));
                (uploadedFiles.interviews || []).forEach(f => form.append('interviews', f));
                if (uploadedFiles.domainMap) {
                    form.append('domain_map', uploadedFiles.domainMap);
                }

                const res = await fetch('/api/generate-futures-triangle', {
                    method: 'POST',
                    body: form  // Changed from JSON to FormData to include files
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate futures triangle');

                const triangle = data.futures_triangle || {};
                document.getElementById('futures-triangle-content').style.display = 'block';
                renderFuturesTriangle(triangle);
            } catch (err) {
                alert(err.message || 'Error generating futures triangle');
            } finally {
                button.innerHTML = '<span>üìä</span> Generate Futures Triangle';
                button.disabled = false;
            }
        }

        // ADD: Save STEEPV function
        async function saveSTEEPV() {
            const button = document.getElementById('save-steepv-btn');
            button.innerHTML = '<span>‚è≥</span> Saving...';
            button.disabled = true;
            
            try {
                // Collect edited STEEPV data
                const categories = ['social', 'technological', 'economic', 'environmental', 'political', 'values'];
                const steepvData = {};
                
                categories.forEach(cat => {
                    const element = document.getElementById(`steepv-${cat}`);
                    steepvData[cat] = element ? element.innerHTML.trim() : '';
                });
                
                // Store in global variable for next phase
                savedSTEEPVData = steepvData;
                
                // Optional: Send to server to save
                const domain = resolveFinalDomain();
                const response = await fetch('/api/save-steepv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, steepv_data: steepvData })
                });
                
                if (response.ok) {
                    // Visual feedback
                    button.innerHTML = '<span>‚úÖ</span> Saved Successfully';
                    setTimeout(() => {
                        button.innerHTML = '<span>üíæ</span> Save STEEPV Analysis';
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                console.error('Save error:', err);
                button.innerHTML = '<span>‚ùå</span> Save Failed';
                setTimeout(() => {
                    button.innerHTML = '<span>üíæ</span> Save STEEPV Analysis';
                    button.disabled = false;
                }, 2000);
            }
        }

        // ADD: Save Futures Triangle function
        async function saveFuturesTriangle() {
            const button = document.getElementById('save-triangle-btn');
            button.innerHTML = '<span>‚è≥</span> Saving...';
            button.disabled = true;
            
            try {
                // Collect edited Futures Triangle data
                const triangleData = {
                    pull_of_future: document.getElementById('triangle-future')?.innerHTML.trim() || '',
                    push_of_present: document.getElementById('triangle-present')?.innerHTML.trim() || '',
                    weight_of_history: document.getElementById('triangle-past')?.innerHTML.trim() || '',
                    key_dynamics: {
                        primary_tensions: document.getElementById('dynamics-tensions')?.innerHTML.trim() || '',
                        alignment_opportunities: document.getElementById('dynamics-alignment')?.innerHTML.trim() || '',
                        critical_uncertainties: document.getElementById('dynamics-uncertainties')?.innerHTML.trim() || ''
                    }
                };
                
                // Store in global variable for next phase
                savedFuturesTriangleData = triangleData;
                
                // Optional: Send to server to save
                const domain = resolveFinalDomain();
                const response = await fetch('/api/save-futures-triangle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, futures_triangle_data: triangleData })
                });
                
                if (response.ok) {
                    // Visual feedback
                    button.innerHTML = '<span>‚úÖ</span> Saved Successfully';
                    setTimeout(() => {
                        button.innerHTML = '<span>üíæ</span> Save Futures Triangle';
                        button.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Failed to save');
                }
            } catch (err) {
                console.error('Save error:', err);
                button.innerHTML = '<span>‚ùå</span> Save Failed';
                setTimeout(() => {
                    button.innerHTML = '<span>üíæ</span> Save Futures Triangle';
                    button.disabled = false;
                }, 2000);
            }
        }

        // ADD: Save Phase 1 Progress function
        async function savePhase1Progress() {
            const button = event.target.closest('.btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<span>‚è≥</span> Saving...';
            button.disabled = true;
            
            try {
                // Collect all Phase 1 data
                const projectName = document.getElementById('project-name').value.trim();
                const domainSelect = document.getElementById('domain-select').value;
                const newDomainName = document.getElementById('new-domain-name').value.trim();
                const finalDomain = resolveFinalDomain();
                
                // Get domain map content if generated
                const domainMapContent = document.getElementById('domain-map-content').innerHTML;
                const domainMapVisible = document.getElementById('domain-map-content').style.display !== 'none';
                
                // Get interview analysis content if generated
                const interviewAnalysisContent = document.getElementById('interview-analysis-content').innerHTML;
                const interviewAnalysisVisible = document.getElementById('interview-analysis').style.display !== 'none';
                
                // Prepare data object
                const phase1Data = {
                    project_name: projectName,
                    domain_select: domainSelect,
                    new_domain_name: newDomainName,
                    final_domain: finalDomain,
                    domain_map_generated: domainMapVisible,
                    domain_map_content: domainMapVisible ? domainMapContent : '',
                    interview_analysis_generated: interviewAnalysisVisible,
                    interview_analysis_content: interviewAnalysisVisible ? interviewAnalysisContent : '',
                    uploaded_files: {
                        domain_map_files: uploadedFiles.domainMap ? uploadedFiles.domainMap.name : null,
                        interview_files: uploadedFiles.interviews ? uploadedFiles.interviews.map(f => f.name) : [],
                        documents_count: uploadedFiles.documents ? uploadedFiles.documents.length : 0
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Store in global variable
                savedPhase1Data = phase1Data;
                
                // Store in localStorage for persistence
                localStorage.setItem('phase1_progress', JSON.stringify(phase1Data));
                
                // Optional: Send to server
                const response = await fetch('/api/save-phase1-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(phase1Data)
                });
                
                if (response.ok) {
                    // Success feedback
                    button.innerHTML = '<span>‚úÖ</span> Saved Successfully';
                    
                    // Show success message
                    showSuccessMessage('Phase 1 progress saved successfully!');
                    
                } else {
                    throw new Error('Server save failed');
                }
                
            } catch (err) {
                console.error('Save error:', err);
                // Even if server fails, local storage still works
                if (savedPhase1Data) {
                    button.innerHTML = '<span>‚úÖ</span> Saved Locally';
                    showSuccessMessage('Progress saved locally!');
                } else {
                    button.innerHTML = '<span>‚ùå</span> Save Failed';
                    showErrorMessage('Failed to save progress. Please try again.');
                }
            } finally {
                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        async function generateFuturesTriangle2() {
            const button = event.target.closest('.btn-ai');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');

                // Get saved data from previous phases
                const phase1Data = savedPhase1Data || JSON.parse(localStorage.getItem('phase1_progress') || '{}');
                const phase2Data = {
                    signals_data: lastSignalsData || {},
                    steepv_data: savedSTEEPVData || {},
                    futures_triangle_data: savedFuturesTriangleData || {}
                };

                // Prepare form data
                const form = new FormData();
                form.append('domain', domain);
                form.append('phase1_data', JSON.stringify(phase1Data));
                form.append('phase2_data', JSON.stringify(phase2Data));

                // Include all uploaded files for context
                (uploadedFiles.documents || []).forEach(f => form.append('documents', f));
                (uploadedFiles.signals || []).forEach(f => form.append('signals', f));
                (uploadedFiles.interviews || []).forEach(f => form.append('interviews', f));
                if (uploadedFiles.domainMap) {
                    form.append('domain_map', uploadedFiles.domainMap);
                }

                const res = await fetch('/api/generate-futures-triangle-2-0', {
                    method: 'POST',
                    body: form
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate Futures Triangle 2.0');

                const triangle2 = data.futures_triangle_2_0 || {};
                
                // Show the content section
                document.getElementById('futures-triangle-2-content').style.display = 'block';
                
                // Render the results
                renderFuturesTriangle2(triangle2);
                
                // Enable next step (Baseline Scenario)
                document.getElementById('baseline-btn').disabled = false;
                
                // Store for next steps
                window.savedTriangle2Data = triangle2;

            } catch (err) {
                alert(err.message || 'Error generating Futures Triangle 2.0');
            } finally {
                button.innerHTML = '<span>üî∫</span> Generate Analysis';
                button.disabled = false;
            }
        }

        async function generateBaselineScenario() {
            const button = document.getElementById('baseline-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            // ADD THESE LINES TO CLEAR EXISTING CONTENT:
            document.getElementById('baseline-scenario-content').style.display = 'none';
            document.getElementById('baseline-text').innerHTML = '';
            document.getElementById('baseline-title').textContent = '';

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                
                // Check if Futures Triangle 2.0 data exists
                if (!window.savedTriangle2Data) {
                    throw new Error('Please generate Futures Triangle 2.0 first');
                }

                const payload = {
                    domain: domain,
                    triangle_2_0_data: window.savedTriangle2Data,
                    phase1_data: savedPhase1Data || {}
                };

                const res = await fetch('/api/generate-baseline-scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate baseline scenario');

                const baseline = data.baseline_scenario || {};
                
                // Show the content section
                document.getElementById('baseline-scenario-content').style.display = 'block';
                
                // Render the baseline scenario
                renderBaselineScenario(baseline);
                
                // Enable next step (Driver Outcomes)
                document.getElementById('driver-outcomes-btn').disabled = false;
                
                // Store for next steps
                window.savedBaselineData = baseline;

            } catch (err) {
                alert(err.message || 'Error generating baseline scenario');
            } finally {
                button.innerHTML = '<span>üìà</span> Generate Baseline Scenario';
                button.disabled = false;
            }
        }

        async function generateDriverOutcomes() {
            const button = document.getElementById('driver-outcomes-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;
            
            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                
                // Check required data exists
                if (!window.savedTriangle2Data) {
                    throw new Error('Please generate Futures Triangle 2.0 first');
                }
                if (!window.savedBaselineData) {
                    throw new Error('Please generate Baseline Scenario first');
                }
                
                const payload = {
                    domain: domain,
                    triangle_2_0_data: window.savedTriangle2Data,
                    baseline_data: window.savedBaselineData,
                    phase1_data: savedPhase1Data || {}
                };

                const res = await fetch('/api/generate-driver-outcomes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate driver outcomes');
                
                const outcomes = data.driver_outcomes || {};
                
                // Show content section
                document.getElementById('driver-outcomes-content').style.display = 'block';
                
                // Render the outcomes
                renderDriverOutcomes(outcomes);
                
                // Enable next step
                document.getElementById('alt-scenarios-btn').disabled = false;
                
                // Store for next steps
                window.savedDriverOutcomes = outcomes;
                
            } catch (err) {
                alert(err.message || 'Error generating driver outcomes');
            } finally {
                button.innerHTML = '<span>üéØ</span> Generate Driver Outcomes';
                button.disabled = false;
            }
        }

        async function generateAlternativeScenarios() {
            const button = document.getElementById('alt-scenarios-btn');
            button.innerHTML = '<span>‚è≥</span> Generating...';
            button.disabled = true;

            try {
                const domain = resolveFinalDomain();
                if (!domain) throw new Error('Please set domain in Phase 1');
                
                // Get user selections
                const collapseCount = parseInt(document.getElementById('collapse-count').value);
                const newEquilibriumCount = parseInt(document.getElementById('new-equilibrium-count').value);
                const transformationCount = parseInt(document.getElementById('transformation-count').value);
                
                if (collapseCount + newEquilibriumCount + transformationCount === 0) {
                    throw new Error('Please select at least one scenario to generate');
                }
                
                // Check required data exists
                if (!window.savedBaselineData) {
                    throw new Error('Please generate Baseline Scenario first');
                }
                if (!window.savedDriverOutcomes) {
                    throw new Error('Please generate Driver Outcomes first');
                }
                
                const payload = {
                    domain: domain,
                    collapse_count: collapseCount,
                    new_equilibrium_count: newEquilibriumCount,
                    transformation_count: transformationCount,
                    baseline_data: window.savedBaselineData,
                    driver_outcomes: window.savedDriverOutcomes,
                    triangle_2_0_data: window.savedTriangle2Data || {}
                };
                
                const res = await fetch('/api/generate-alternative-scenarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Failed to generate scenarios');
                
                const scenarios = data.alternative_scenarios || {};
                
                // Show content section
                document.getElementById('alternative-scenarios-content').style.display = 'block';
                
                // Render the scenarios
                renderAlternativeScenarios(scenarios);
                
                // Store for next steps or export
                window.savedAlternativeScenarios = scenarios;
                
            } catch (err) {
                alert(err.message || 'Error generating alternative scenarios');
            } finally {
                button.innerHTML = '<span>üîÆ</span> Generate Alternative Scenarios';
                button.disabled = false;
            }
        }

        // Helper Functions
        function resolveFinalDomain() {
            const select = document.getElementById('domain-select');
            const newDom = document.getElementById('new-domain-name').value.trim();
            if (select.value === 'new') return newDom || '';
            const map = {
                'food-security': 'Food Security & Self-Sufficiency',
                'human-capital': 'Human Capital & TVET',
                'sme-fiscal': 'SMEs & Fiscal Policy',
                'renewable-energy': 'Renewable Energy',
                'digital-economy': 'Digital Economy'
            };
            return map[select.value] || '';
        }

        function renderSignalsTabs(signals) {
            const strong = extractSignals(signals, 'strong_signals');
            const weak = extractSignals(signals, 'weak_signals');
            const strongEl = document.getElementById('signals-strong');
            const weakEl = document.getElementById('signals-weak');
            strongEl.innerHTML = strong.map(renderSignalCardStrong).join('') || '<p>No strong signals found</p>';
            weakEl.innerHTML = weak.map(renderSignalCardWeak).join('') || '<p>No weak signals found</p>';
            strongEl.style.display = 'block';
            weakEl.style.display = 'none';
            document.querySelector('#signals-tabs .tab[data-tab="strong"]').click();
        }

        function extractSignals(obj, key) {
            if (!obj) return [];
            if (Array.isArray(obj[key])) return obj[key];
            if (obj.raw_response) {
                try {
                    const m = obj.raw_response.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                    const parsed = JSON.parse(m ? m[1] : obj.raw_response);
                    return Array.isArray(parsed[key]) ? parsed[key] : [];
                } catch (_) { return []; }
            }
            return [];
        }

        function renderSignalCardStrong(s) {
            const title = (s && s.title) || 'Strong Signal';
            const desc = (s && s.description) || '';
            const source = (s && s.source) || 'Document Analysis';
            const impact = (s && s.impact) || 'High impact';
            return `<div class="signal-card strong"><h4>üü¢ ${title}</h4><p>${desc}</p><small><strong>Source:</strong> ${source}</small><br><small><strong>Impact:</strong> ${impact}</small></div>`;
        }

        function renderSignalCardWeak(s) {
            const title = (s && s.title) || 'Weak Signal';
            const desc = (s && s.description) || '';
            const source = (s && s.source) || 'Document Analysis';
            const potential = (s && s.potential) || 'Emerging trend';
            return `<div class="signal-card weak"><h4>üü° ${title}</h4><p>${desc}</p><small><strong>Source:</strong> ${source}</small><br><small><strong>Potential:</strong> ${potential}</small></div>`;
        }

        function renderAISuggestion(s) {
            const title = (s && s.title) || 'AI Suggestion';
            const desc = (s && s.description) || '';
            const category = (s && s.category) || 'Weak';
            const rationale = (s && s.rationale) || '';
            const cls = category === 'Strong' ? 'strong' : 'weak';
            return `<div class="signal-card ${cls}"><h4>üí° ${title}</h4><p>${desc}</p><small><strong>Category:</strong> ${category}</small><br><small><strong>Rationale:</strong> ${rationale}</small></div>`;
        }

        function renderInterviewAnalysis(analysis) {
            const challenges = (analysis && analysis.challenges) || [];
            const opportunities = (analysis && analysis.opportunities) || [];
            const visions = (analysis && analysis.visions) || [];
            return `
                <div class="cards-grid">
                    <div class="card"><h4>üéØ Top Challenges</h4><ul>${challenges.map(i => `<li>${i}</li>`).join('')}</ul></div>
                    <div class="card"><h4>üí° Key Opportunities</h4><ul>${opportunities.map(i => `<li>${i}</li>`).join('')}</ul></div>
                    <div class="card"><h4>üîÆ Future Visions</h4><ul>${visions.map(i => `<li>${i}</li>`).join('')}</ul></div>
                </div>`;
        }


        function renderDomainMap(dm) {
            const central = dm.central_domain || 'Domain Analysis';
            const desc = dm.description || '';
            const sub = Array.isArray(dm.sub_domains) ? dm.sub_domains : [];
            
            return `
                <div>
                    <h4>Central Domain: ${central}</h4>
                    ${desc ? `<p><em>${desc}</em></p>` : ''}
                    ${sub.length ? `
                        <div style="margin-top: 1rem;">
                            <h5>Sub-domains:</h5>
                            ${sub.map(s => `
                                <div class="signal-card" style="border-left-color:#9b59b6">
                                    <strong>${(s && s.name) || 'Sub-domain'}</strong><br>
                                    ${(s && s.description) || ''}<br>
                                    <small><strong>Relevance:</strong> ${(s && s.relevance) || 'Medium'}</small>
                                    ${(s && s.issue_areas && s.issue_areas.length) ? `
                                        <div style="margin-top: 0.5rem;">
                                            <strong>Issue Areas:</strong>
                                            <ul style="margin: 0.3rem 0; padding-left: 1.2rem;">
                                                ${s.issue_areas.map(issue => `<li>${issue}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>` : ''}
                </div>`;
        }


        function renderMindMap(mindmapData) {
            const container = document.getElementById('mindmap-visualization');
            container.innerHTML = '';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '1000');
            svg.setAttribute('viewBox', '0 0 1600 1000');
            svg.style.background = 'white';
            
            const centralDomain = mindmapData.central_domain || 'Central Domain';
            const subDomains = mindmapData.sub_domains || [];
            
            // Better pastel color schemes with good contrast
            const clusterColors = [
                '#87CEEB', // Sky blue
                '#FFB347', // Peach
                '#DDA0DD', // Plum  
                '#98FB98', // Pale green
                '#F0E68C', // Khaki
                '#FFA07A', // Light salmon
                '#E6E6FA', // Lavender
                '#AFEEEE', // Pale turquoise
                '#FFDAB9'  // Peach puff
            ];
            
            const centerX = 800;
            const centerY = 500;
            
            // Central domain bubble (larger and darker)
            const centralBubble = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centralBubble.setAttribute('cx', centerX);
            centralBubble.setAttribute('cy', centerY);
            centralBubble.setAttribute('r', '85');
            centralBubble.setAttribute('fill', '#4A5568');
            centralBubble.setAttribute('stroke', '#2D3748');
            centralBubble.setAttribute('stroke-width', '2');
            svg.appendChild(centralBubble);
            
            // Helper function to create multi-line text
            function createMultiLineText(svgElement, x, y, text, fontSize, fontWeight, fill, maxWidth, maxLines = 2) {
                const words = text.split(' ');
                const lines = [];
                let currentLine = [];
                
                // Improved word wrapping with better character count calculation
                const maxCharsPerLine = Math.floor(maxWidth / (fontSize * 0.5));
                
                words.forEach(word => {
                    const currentLineText = currentLine.join(' ');
                    if ((currentLineText + ' ' + word).length <= maxCharsPerLine || currentLine.length === 0) {
                        currentLine.push(word);
                    } else {
                        if (lines.length < maxLines - 1) {
                            lines.push(currentLine.join(' '));
                            currentLine = [word];
                        } else {
                            // Last line - add ellipsis if needed
                            const remainingWords = words.slice(words.indexOf(word));
                            const lastLine = currentLine.join(' ');
                            if (remainingWords.length > 0 && (lastLine + ' ' + word).length > maxCharsPerLine) {
                                lines.push(lastLine + '...');
                                currentLine = [];
                            } else {
                                currentLine.push(word);
                            }
                        }
                    }
                });
                
                if (currentLine.length > 0 && lines.length < maxLines) {
                    lines.push(currentLine.join(' '));
                }
                
                // Create text elements
                const lineHeight = fontSize * 1.2;
                const startY = y - ((lines.length - 1) * lineHeight) / 2;
                
                lines.forEach((line, index) => {
                    const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('x', x);
                    textElement.setAttribute('y', startY + (index * lineHeight));
                    textElement.setAttribute('text-anchor', 'middle');
                    textElement.setAttribute('dominant-baseline', 'middle');
                    textElement.setAttribute('font-family', 'Arial, Helvetica, sans-serif');
                    textElement.setAttribute('font-size', fontSize);
                    textElement.setAttribute('font-weight', fontWeight);
                    textElement.setAttribute('fill', fill);
                    textElement.textContent = line;
                    svgElement.appendChild(textElement);
                });
            }
            
            // Central domain text
            createMultiLineText(svg, centerX, centerY, centralDomain, 14, 'bold', 'white', 150, 2);
            
            // Create clusters around the center
            subDomains.forEach((subDomain, clusterIndex) => {
                const clusterColor = clusterColors[clusterIndex % clusterColors.length];
                const clusterAngle = (clusterIndex / subDomains.length) * 2 * Math.PI;
                
                // Reduced cluster distance to 200
                const clusterDistance = 200;
                const clusterCenterX = centerX + Math.cos(clusterAngle) * clusterDistance;
                const clusterCenterY = centerY + Math.sin(clusterAngle) * clusterDistance;
                
                // Create sub-domain bubble
                const subDomainBubble = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                subDomainBubble.setAttribute('cx', clusterCenterX);
                subDomainBubble.setAttribute('cy', clusterCenterY);
                subDomainBubble.setAttribute('r', '70');
                subDomainBubble.setAttribute('fill', clusterColor);
                subDomainBubble.setAttribute('stroke', '#333');
                subDomainBubble.setAttribute('stroke-width', '2');
                svg.appendChild(subDomainBubble);
                
                // Sub-domain text
                const subDomainName = subDomain.name || 'Sub-domain';
                createMultiLineText(svg, clusterCenterX, clusterCenterY, subDomainName, 12, '600', '#000', 120, 2);
                
                // Add issue bubbles around the cluster center - ONLY ON THE RIGHT SIDE
                const issues = subDomain.issue_areas || [];
                
                if (issues.length > 0) {
                    // Calculate right side angle range (90 degrees to the right of clusterAngle)
                    const rightSideStartAngle = clusterAngle - Math.PI/4; // -45 degrees from cluster direction
                    const rightSideEndAngle = clusterAngle + Math.PI/4;   // +45 degrees from cluster direction
                    
                    // Define row structure: 3 issues in first row, 3 in second, 2 in third
                    const row1Count = Math.min(3, issues.length);
                    const row2Count = Math.min(3, issues.length - row1Count);
                    const row3Count = issues.length - row1Count - row2Count;
                    
                    issues.forEach((issue, issueIndex) => {
                        let row, col;
                        
                        // Determine row and column based on the 3-3-2 structure
                        if (issueIndex < row1Count) {
                            // First row: up to 3 issues
                            row = 0;
                            col = issueIndex;
                        } else if (issueIndex < row1Count + row2Count) {
                            // Second row: up to 3 issues
                            row = 1;
                            col = issueIndex - row1Count;
                        } else {
                            // Third row: remaining issues (usually 2)
                            row = 2;
                            col = issueIndex - row1Count - row2Count;
                        }
                        
                        // Calculate angle position within the row
                        let issueAngle;
                        if (row === 0 && row1Count === 1) {
                            // Single issue in first row - center it
                            issueAngle = (rightSideStartAngle + rightSideEndAngle) / 2;
                        } else if (row === 0 || row === 1) {
                            // First or second row with 3 issues - spread them out more
                            const angleStep = (rightSideEndAngle - rightSideStartAngle) / (row1Count > 1 ? row1Count : 1);
                            issueAngle = rightSideStartAngle + col * angleStep;
                        } else {
                            // Third row with 2 issues - center them with more spacing
                            if (row3Count === 1) {
                                // Single issue in third row - center it
                                issueAngle = (rightSideStartAngle + rightSideEndAngle) / 2;
                            } else {
                                // Two issues in third row - position with more spacing
                                issueAngle = rightSideStartAngle + ((col + 1) / (row3Count + 1)) * (rightSideEndAngle - rightSideStartAngle);
                            }
                        }
                        
                        // Calculate distance based on row - REDUCED DISTANCE STEP TO BRING ROWS CLOSER
                        const baseDistance = 180; // Keep first row distance unchanged
                        const distanceStep = 100; // Reduced from 150 to bring rows closer
                        const issueDistance = baseDistance + row * distanceStep;
                        
                        const issueX = clusterCenterX + Math.cos(issueAngle) * issueDistance;
                        const issueY = clusterCenterY + Math.sin(issueAngle) * issueDistance;
                        
                        // Slightly reduced bubble sizes to create more gap
                        const textLength = issue.length;
                        let bubbleRadius;
                        if (textLength <= 10) {
                            bubbleRadius = 35; // Reduced from 38
                        } else if (textLength <= 20) {
                            bubbleRadius = 40; // Reduced from 44
                        } else {
                            bubbleRadius = 45; // Reduced from 50
                        }
                        
                        // Issue bubble with dynamic sizing
                        const issueBubble = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        issueBubble.setAttribute('cx', issueX);
                        issueBubble.setAttribute('cy', issueY);
                        issueBubble.setAttribute('r', bubbleRadius);
                        issueBubble.setAttribute('fill', clusterColor);
                        issueBubble.setAttribute('stroke', '#333');
                        issueBubble.setAttribute('stroke-width', '1.5');
                        issueBubble.setAttribute('opacity', '0.9');
                        svg.appendChild(issueBubble);
                        
                        // Issue text with improved sizing
                        const maxTextWidth = bubbleRadius * 2.2;
                        createMultiLineText(svg, issueX, issueY, issue, 8, '500', '#000', maxTextWidth, 3);
                    });
                }
            });
            
            container.appendChild(svg);
        }

        function renderSTEEPV(steepv) {
            const categories = ['social', 'technological', 'economic', 'environmental', 'political', 'values'];
            categories.forEach(cat => {
                const element = document.getElementById(`steepv-${cat}`);
                const data = steepv[cat] || steepv[cat.charAt(0).toUpperCase() + cat.slice(1)] || [];
                if (Array.isArray(data) && data.length > 0) {
                    element.innerHTML = data.map(item => 
                        typeof item === 'string' ? `‚Ä¢ ${item}` : `‚Ä¢ ${item.title || item.signal || item}`
                    ).join('<br>');
                } else {
                    element.innerHTML = 'No signals identified for this category';
                }
            });
        }

        function renderFuturesTriangle(triangle) {
            // Extract the three main forces
            const pullOfFuture = triangle.pull_of_future || {};
            const pushOfPresent = triangle.push_of_present || {};
            const weightOfHistory = triangle.weight_of_history || {};
            const keyDynamics = triangle.key_dynamics || {};

            function formatDetailedItems(obj) {
                if (!obj) return 'No data available';
                
                let html = '';
                for (const [key, items] of Object.entries(obj)) {
                    if (Array.isArray(items) && items.length > 0) {
                        const sectionTitle = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `<div style="margin-bottom: 1rem;"><strong>${sectionTitle}:</strong><br>`;
                        html += items.map(item => `‚Ä¢ ${item}`).join('<br>');
                        html += '</div>';
                    }
                }
                return html || 'No items identified';
            }

            function formatSimpleItems(items) {
                if (!Array.isArray(items) || items.length === 0) {
                    return 'No items identified';
                }
                return items.map(item => `‚Ä¢ ${item}`).join('<br>');
            }

            // Render Pull of the Future (first)
            document.getElementById('triangle-future').innerHTML = formatDetailedItems(pullOfFuture);

            // Render Push of the Present (second)  
            document.getElementById('triangle-present').innerHTML = formatDetailedItems(pushOfPresent);

            // Render Weight of History (third)
            document.getElementById('triangle-past').innerHTML = formatDetailedItems(weightOfHistory);

            // Render Key Dynamics & Strategic Insights
            document.getElementById('dynamics-tensions').innerHTML = 
                formatSimpleItems(keyDynamics.primary_tensions) || 'No primary tensions identified';

            document.getElementById('dynamics-alignment').innerHTML = 
                formatSimpleItems(keyDynamics.alignment_opportunities) || 'No alignment opportunities identified';

            document.getElementById('dynamics-uncertainties').innerHTML = 
                formatSimpleItems(keyDynamics.critical_uncertainties) || 'No critical uncertainties identified';
        }

        // ADD: Helper functions for success/error messages
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-weight: 500;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function showErrorMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-weight: 500;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ADD: Load saved progress on page load
        function loadPhase1Progress() {
            try {
                const saved = localStorage.getItem('phase1_progress');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Restore form fields
                    if (data.project_name) {
                        document.getElementById('project-name').value = data.project_name;
                    }
                    if (data.domain_select) {
                        document.getElementById('domain-select').value = data.domain_select;
                        handleDomainSelection(); // Trigger domain selection logic
                    }
                    if (data.new_domain_name) {
                        document.getElementById('new-domain-name').value = data.new_domain_name;
                    }
                    
                    // Restore generated content
                    if (data.domain_map_generated && data.domain_map_content) {
                        document.getElementById('domain-map-content').innerHTML = data.domain_map_content;
                        document.getElementById('domain-map-content').style.display = 'block';
                    }
                    
                    if (data.interview_analysis_generated && data.interview_analysis_content) {
                        document.getElementById('interview-analysis-content').innerHTML = data.interview_analysis_content;
                        document.getElementById('interview-analysis').style.display = 'block';
                    }
                    
                    savedPhase1Data = data;
                    console.log('Phase 1 progress loaded from localStorage');
                }
            } catch (err) {
                console.error('Error loading saved progress:', err);
            }
        }

        function renderFuturesTriangle2(triangle2) {
            // Render Drivers
            const driversContent = document.getElementById('drivers-content');
            const drivers = triangle2.drivers || [];
            if (drivers.length > 0) {
                driversContent.innerHTML = drivers.map(d => `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid #e74c3c;">
                        <strong>${d.name}</strong> <span style="color: #666; font-size: 0.875rem;">(${d.impact_level} Impact, ${d.certainty} Certainty)</span><br>
                        <span style="color: #555;">${d.description}</span><br>
                        <small style="color: #888;"><strong>Category:</strong> ${d.category} | <strong>Trajectory:</strong> ${d.current_trajectory}</small>
                    </div>
                `).join('');
            }

            // Render Uncertainties
            const uncertaintiesContent = document.getElementById('uncertainties-content');
            const uncertainties = triangle2.uncertainties || [];
            if (uncertainties.length > 0) {
                uncertaintiesContent.innerHTML = uncertainties.map(u => `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid #f39c12;">
                        <strong>${u.name}</strong><br>
                        <span style="color: #555;">${u.description}</span><br>
                        <small style="color: #888;"><strong>Possible outcomes:</strong> ${u.possible_outcomes?.join(', ') || 'Various outcomes possible'}</small>
                    </div>
                `).join('');
            }

            // Render Narratives
            const narrativesContent = document.getElementById('narratives-content');
            const narratives = triangle2.narratives || [];
            if (narratives.length > 0) {
                narrativesContent.innerHTML = narratives.map(n => `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid #9b59b6;">
                        <strong>${n.name}</strong> <span style="color: #666; font-size: 0.875rem;">(${n.type})</span><br>
                        <span style="color: #555;">${n.description}</span><br>
                        <small style="color: #888;"><strong>Influence:</strong> ${n.influence_areas?.join(', ') || 'Multiple areas'}</small>
                    </div>
                `).join('');
            }
        }

        function renderBaselineScenario(baseline) {
            // Clear any existing content first
            document.getElementById('baseline-text').innerHTML = '';
            // Update title
            const titleElement = document.getElementById('baseline-title');
            if (titleElement) {
                titleElement.textContent = baseline.scenario_title || 'Baseline Continuation Scenario';
            }
            
            // Update scenario text
            const textElement = document.getElementById('baseline-text');
            if (textElement) {
                // Convert plain text to HTML with paragraph breaks
                const scenarioText = baseline.scenario_text || '';
                const paragraphs = scenarioText.split('\n\n').filter(p => p.trim());
                
                let html = '';
                paragraphs.forEach((paragraph, index) => {
                    if (paragraph.trim()) {
                        html += `<p>${paragraph.trim()}</p>`;
                    }
                });
                
                // Add key assumptions if available
                // Add key assumptions if available
                if (baseline.key_assumptions) {
                    // Ensure key_assumptions is always an array
                    let assumptions = Array.isArray(baseline.key_assumptions) 
                        ? baseline.key_assumptions 
                        : [baseline.key_assumptions];
                    
                    if (assumptions.length > 0) {
                        html += '<div style="margin-top: 1.5rem;"><strong>Key Assumptions:</strong><ul>';
                        assumptions.forEach(assumption => {
                            html += `<li>${assumption}</li>`;
                        });
                        html += '</ul></div>';
                    }
}
                
                // Add dominant drivers if available
                // Add dominant drivers if available
                if (baseline.dominant_drivers) {
                    // Ensure dominant_drivers is always an array
                    let drivers = Array.isArray(baseline.dominant_drivers) 
                        ? baseline.dominant_drivers 
                        : [baseline.dominant_drivers];
                    
                    if (drivers.length > 0) {
                        html += '<div style="margin-top: 1rem;"><strong>Dominant Drivers:</strong><ul>';
                        drivers.forEach(driver => {
                            html += `<li>${driver}</li>`;
                        });
                        html += '</ul></div>';
                    }
                }
                
                textElement.innerHTML = html;
            }
            
            // Add timeframe info if available
            if (baseline.timeframe) {
                const timeInfo = document.createElement('div');
                timeInfo.style.cssText = 'background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; color: #666;';
                timeInfo.innerHTML = `<strong>Timeframe:</strong> ${baseline.timeframe}`;
                textElement.parentNode.insertBefore(timeInfo, textElement);
            }
        }

        function renderDriverOutcomes(outcomes) {
            const driverSection = document.getElementById('driver-outcomes-results');
            if (!driverSection) {
                console.error('Element driver-outcomes-results not found');
                return;
            }
            
            let html = '';
            
            // EXISTING: Driver Outcomes
            const drivers = outcomes.driver_outcomes || [];
            if (drivers.length > 0) {
                html += '<h4>üîÑ Driver Outcomes</h4>';
                drivers.forEach(driver => {
                    html += `
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <h5 style="color: #2c3e50; margin-bottom: 1rem;">${driver.driver_name || 'Unnamed Driver'}</h5>
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #e8f5e5; border-radius: 4px;">
                            <strong>Baseline:</strong> ${driver.baseline_trajectory || 'No baseline specified'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            ${(driver.outcomes || []).map(outcome => `
                                <div style="padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid ${getArchetypeColor(outcome.archetype)};">
                                    <strong>${outcome.archetype || 'Unknown'}</strong><br>
                                    <span style="color: #555; font-size: 0.9rem;">${outcome.outcome_text || 'No outcome text'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }

            // ADD: Uncertainty Outcomes
            const uncertainties = outcomes.uncertainty_outcomes || [];
            if (uncertainties.length > 0) {
                html += '<h4>‚ùì Uncertainty Outcomes</h4>';
                uncertainties.forEach(uncertainty => {
                    html += `
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #fff8dc; border-radius: 8px;">
                        <h5 style="color: #2c3e50; margin-bottom: 1rem;">${uncertainty.uncertainty_name || 'Unnamed Uncertainty'}</h5>
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #ffeaa7; border-radius: 4px;">
                            <strong>Key Variables:</strong> ${(uncertainty.key_variables || []).join(', ') || 'Not specified'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            ${(uncertainty.outcomes || []).map(outcome => `
                                <div style="padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid ${getArchetypeColor(outcome.archetype)};">
                                    <strong>${outcome.archetype || 'Unknown'}</strong><br>
                                    <span style="color: #555; font-size: 0.9rem;">${outcome.outcome_text || 'No outcome text'}</span><br>
                                    <small style="color: #777;"><strong>Resolution:</strong> ${outcome.resolution_direction || 'Not specified'}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }

            // ADD: Narrative Outcomes
            const narratives = outcomes.narrative_outcomes || [];
            if (narratives.length > 0) {
                html += '<h4>üìñ Narrative Outcomes</h4>';
                narratives.forEach(narrative => {
                    html += `
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #f0e6ff; border-radius: 8px;">
                        <h5 style="color: #2c3e50; margin-bottom: 1rem;">${narrative.narrative_name || 'Unnamed Narrative'}</h5>
                        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #d1c4e9; border-radius: 4px;">
                            <strong>Type:</strong> ${narrative.narrative_type || 'Not specified'}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            ${(narrative.outcomes || []).map(outcome => `
                                <div style="padding: 0.75rem; background: white; border-radius: 4px; border-left: 4px solid ${getArchetypeColor(outcome.archetype)};">
                                    <strong>${outcome.archetype || 'Unknown'}</strong><br>
                                    <span style="color: #555; font-size: 0.9rem;">${outcome.outcome_text || 'No outcome text'}</span><br>
                                    <small style="color: #777;"><strong>Story Shift:</strong> ${outcome.narrative_shift || 'Not specified'}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }

            // ADD: Cross-Archetype Insights
            const insights = outcomes.cross_archetype_insights || {};
            if (Object.keys(insights).length > 0) {
                html += `
                <div style="margin-top: 2rem; padding: 1.5rem; background: #f5f7fa; border-radius: 8px; border: 2px solid #1976d2;">
                    <h4>üîç Cross-Archetype Insights</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem;">
                        <div>
                            <h5 style="color: #e74c3c;">üîª Collapse Patterns</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${(insights.collapse_patterns || []).map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            
                            <h5 style="color: #f39c12; margin-top: 1rem;">‚öñÔ∏è Equilibrium Patterns</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${(insights.equilibrium_patterns || []).map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 style="color: #27ae60;">üöÄ Transformation Patterns</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${(insights.transformation_patterns || []).map(p => `<li>${p}</li>`).join('')}
                            </ul>
                            
                            <h5 style="color: #2c3e50; margin-top: 1rem;">üéØ Leverage Points</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${(insights.leverage_points || []).map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>`;
            }

            if (html) {
                driverSection.innerHTML = html;
            } else {
                driverSection.innerHTML = '<p>No driver outcomes generated yet.</p>';
            }
        }

        function getArchetypeColor(archetype) {
            switch(archetype) {
                case 'Collapse/Decline': return '#e74c3c';
                case 'New Equilibrium': return '#f39c12'; 
                case 'Transformation': return '#27ae60';
                default: return '#3498db';
            }
        }

        function renderAlternativeScenarios(scenarios) {
            const container = document.getElementById('alternative-scenarios-content');
            if (!container) {
                console.error('Alternative scenarios content container not found');
                return;
            }

            if (!scenarios.scenarios || scenarios.scenarios.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>No scenarios generated</h5>
                        <p>Please select at least one archetype scenario to generate.</p>
                    </div>
                `;
                return;
            }

            // Group scenarios by archetype for better organization
            const groupedScenarios = scenarios.scenarios.reduce((acc, scenario) => {
                const archetype = scenario.archetype || 'Unknown';
                if (!acc[archetype]) acc[archetype] = [];
                acc[archetype].push(scenario);
                return acc;
            }, {});

            // Define archetype colors and icons
            const archetypeStyles = {
                'Collapse': { color: '#dc3545', bg: '#f8d7da', icon: '‚ö°' },
                'New Equilibrium': { color: '#ffc107', bg: '#fff3cd', icon: '‚öñÔ∏è' },
                'Transformation': { color: '#28a745', bg: '#d4edda', icon: 'üöÄ' }
            };

            let html = `
                <div class="alternative-scenarios-overview">
                    <h4>Generated Alternative Scenarios</h4>
                    <p style="color: #666; margin-bottom: 2rem;">
                        ${scenarios.scenarios.length} scenario${scenarios.scenarios.length !== 1 ? 's' : ''} 
                        across ${Object.keys(groupedScenarios).length} archetype${Object.keys(groupedScenarios).length !== 1 ? 's' : ''}
                    </p>
                </div>
            `;

            // Render each archetype group
            Object.entries(groupedScenarios).forEach(([archetype, archetypeScenarios]) => {
                const style = archetypeStyles[archetype] || { color: '#6c757d', bg: '#f8f9fa', icon: 'üìã' };
                
                html += `
                    <div class="archetype-group" style="margin-bottom: 2rem;">
                        <div class="archetype-header" style="background-color: ${style.bg}; border-left: 4px solid ${style.color}; padding: 12px 16px; border-radius: 6px; margin-bottom: 1rem;">
                            <h5 style="color: ${style.color}; margin: 0; font-weight: 600;">
                                ${style.icon} ${archetype} Scenarios (${archetypeScenarios.length})
                            </h5>
                        </div>
                `;

                // Render scenarios within this archetype
                archetypeScenarios.forEach((scenario, index) => {
                    html += `
                        <div class="card" style="border-left: 3px solid ${style.color}; margin-bottom: 1.5rem;">
                            <div style="margin-bottom: 15px;">
                                <h6 style="color: ${style.color}; font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">
                                    ${scenario.scenario_title || `${archetype} Scenario ${index + 1}`}
                                </h6>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <span style="background-color: ${style.color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">${archetype}</span>
                                    <span style="background-color: transparent; color: #6c757d; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">${scenario.timeframe || '2025-2030'}</span>
                                    <span style="background-color: transparent; color: #6c757d; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">${scenario.probability_assessment || 'Medium'} Likelihood</span>
                                </div>
                            </div>

                            <div class="scenario-content">
                                <div style="line-height: 1.6; margin-bottom: 20px; color: #2c3e50;">
                                    ${formatScenarioText(scenario.scenario_text || 'No scenario text available')}
                                </div>

                                <div class="cards-grid" style="margin-bottom: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                        <h6 style="margin-bottom: 10px; color: ${style.color};">Key Factors</h6>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${(scenario.key_factors || []).map(factor => 
                                                `<li style="padding: 4px 0; border-bottom: 1px solid #e9ecef; font-size: 0.9rem;">
                                                    <span style="color: #007bff; margin-right: 8px;">‚ñ∂</span>${factor}
                                                </li>`
                                            ).join('')}
                                        </ul>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                                        <h6 style="margin-bottom: 10px; color: ${style.color};">Critical Assumptions</h6>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${(scenario.critical_assumptions || []).map(assumption => 
                                                `<li style="padding: 4px 0; border-bottom: 1px solid #e9ecef; font-size: 0.9rem;">
                                                    <span style="margin-right: 8px;">‚ö°</span>${assumption}
                                                </li>`
                                            ).join('')}
                                        </ul>
                                    </div>
                                </div>

                                <div>
                                    <h6 style="margin-bottom: 10px; color: ${style.color};">Early Warning Indicators</h6>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${(scenario.key_indicators || []).map(indicator => 
                                            `<span style="padding: 4px 12px; background: #f8f9fa; border: 1px solid ${style.color}; border-radius: 16px; font-size: 0.8rem; color: #495057;">${indicator}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`; // Close archetype-group
            });

            // Add export button
            html += `
                <div style="text-align: center; padding: 2rem 0; border-top: 2px solid #e9ecef; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="exportAlternativeScenarios()" style="margin: 0 8px;">
                        üìÑ Export Scenarios
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        // Helper function to format scenario text with proper paragraphs
        function formatScenarioText(text) {
            // Convert to string and handle null/undefined/non-string values
            if (!text || typeof text !== 'string') {
                return '<p>No scenario text available.</p>';
            }
            
            // Convert to string just in case
            text = String(text).trim();
            
            if (!text) {
                return '<p>No scenario text available.</p>';
            }
            
            // Split by double newlines or periods followed by capitals (common paragraph breaks)
            let paragraphs = text.split(/\n\s*\n|\.\s+(?=[A-Z])/);
            
            // If no clear paragraph breaks, try to split by sentence groups
            if (paragraphs.length === 1) {
                const sentences = text.split(/\.\s+/);
                if (sentences.length > 6) {
                    // Group sentences into paragraphs (roughly 2-3 sentences each)
                    paragraphs = [];
                    for (let i = 0; i < sentences.length; i += 3) {
                        paragraphs.push(sentences.slice(i, i + 3).join('. ') + '.');
                    }
                }
            }
            
            // Clean and format paragraphs
            return paragraphs
                .filter(p => p && typeof p === 'string' && p.trim().length > 0)
                .map(paragraph => {
                    const cleaned = String(paragraph).trim().replace(/\n/g, ' ').replace(/\s+/g, ' ');
                    return `<p style="margin-bottom: 12px;">${cleaned}</p>`;
                })
                .join('');
        }

        // Export function for scenarios
        function exportAlternativeScenarios() {
            if (!window.savedAlternativeScenarios) {
                alert('No scenarios to export');
                return;
            }

            const domain = resolveFinalDomain() || 'Unknown Domain';
            const scenarios = window.savedAlternativeScenarios.scenarios || [];
            
            let exportText = `ALTERNATIVE SCENARIOS ANALYSIS\n`;
            exportText += `Domain: ${domain}\n`;
            exportText += `Generated: ${new Date().toLocaleDateString()}\n`;
            exportText += `Total Scenarios: ${scenarios.length}\n\n`;
            exportText += `${'='.repeat(60)}\n\n`;

            scenarios.forEach((scenario, index) => {
                exportText += `SCENARIO ${index + 1}: ${scenario.scenario_title}\n`;
                exportText += `Archetype: ${scenario.archetype}\n`;
                exportText += `Timeframe: ${scenario.timeframe || '2025-2030'}\n`;
                exportText += `Probability: ${scenario.probability_assessment || 'Medium'}\n\n`;
                
                exportText += `NARRATIVE:\n`;
                exportText += `${scenario.scenario_text || 'No narrative available'}\n\n`;
                
                if (scenario.key_factors && scenario.key_factors.length > 0) {
                    exportText += `KEY FACTORS:\n`;
                    scenario.key_factors.forEach(factor => exportText += `‚Ä¢ ${factor}\n`);
                    exportText += `\n`;
                }
                
                if (scenario.critical_assumptions && scenario.critical_assumptions.length > 0) {
                    exportText += `CRITICAL ASSUMPTIONS:\n`;
                    scenario.critical_assumptions.forEach(assumption => exportText += `‚Ä¢ ${assumption}\n`);
                    exportText += `\n`;
                }
                
                if (scenario.key_indicators && scenario.key_indicators.length > 0) {
                    exportText += `EARLY WARNING INDICATORS:\n`;
                    scenario.key_indicators.forEach(indicator => exportText += `‚Ä¢ ${indicator}\n`);
                    exportText += `\n`;
                }
                
                exportText += `${'-'.repeat(60)}\n\n`;
            });

            // Download as text file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alternative-scenarios-${domain.replace(/[^a-z0-9]/gi, '_')}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }




        // Initialize
        // loadPhase1Progress();
        updateProgress();
    </script>
</body>
</html>








